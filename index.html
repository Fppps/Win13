<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">\
    <title>Windows 13 Concept</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Orbitron:wght=700&family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        body { font-family: 'Poppins', sans-serif; user-select: none; color: #e0e0e0; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .font-mono { font-family: 'Fira Code', monospace; } /* Changed to Fira Code */
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        #desktop { transition: background-image 0.5s ease-in-out, background-color 0.5s ease-in-out, opacity 0.5s ease-in-out; background-size: cover; background-position: center; }
        .desktop-light { background-image: url('Assets/Background/Background_Light.png'); }
        .desktop-dark { background-image: url('Assets/Background/Background_dark.png'); }
        .glassmorphism { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); transition: background 0.3s, border 0.3s; }
        .dark .glassmorphism { background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1); }
        /* Removed .no-scrollbar to allow default scrollbars */
        .hide-scrollbars::-webkit-scrollbar { width: 0 !important; height: 0 !important; }
        .hide-scrollbars { -ms-overflow-style: none !important; scrollbar-width: none !important; }
        @keyframes open-animation { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .animate-open { animation: open-animation 0.2s ease-out; }
        .window { transition: opacity 0.2s, transform 0.2s; min-width: 300px; min-height: 200px; }
        .title-bar { cursor: move; }
        .text-shadow { text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .resize-handle { position: absolute; bottom: 0; right: 0; width: 16px; height: 16px; cursor: se-resize; }

        /* Custom style for text editor textarea to give a "code" hint */
        #text-editor-textarea {
            background-color: #1a202c; /* Darker background for code feel */
            border: 1px solid #4a5568; /* Subtle border */
            border-radius: 0.25rem; /* Slightly rounded corners */
            padding: 1rem; /* More padding */
            line-height: 1.5; /* Better readability for code */
        }
    </style>
</head>
<body class="overflow-hidden bg-black text-gray-800 dark:text-gray-200">

    <audio id="boot-sound" src="bootup/boot.mp3" preload="auto"></audio>
    <div id="power-off-screen" class="hidden absolute inset-0 z-[100] flex flex-col items-center justify-center bg-black transition-opacity duration-500"><h2 id="power-off-message" class="text-2xl font-bold text-white mb-6"></h2></div>

    <div id="message-box" class="hidden absolute inset-0 z-[60] flex items-center justify-center bg-black/50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm text-center animate-open">
            <h3 id="message-box-title" class="font-bold text-lg text-white mb-2"></h3>
            <p id="message-box-content" class="text-sm text-gray-300 mb-4"></p>
            <button id="message-box-ok-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-md text-white font-semibold">OK</button>
        </div>
    </div>
    
    <div id="login-container" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-gray-900 transition-opacity duration-500">
        <div id="login-view">
            <img src="https://placehold.co/128x128/7c3aed/ffffff?text=U" alt="User Avatar" class="rounded-full w-32 h-32 border-4 border-purple-500 mb-4 mx-auto">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Welcome Back</h2>
            <div class="w-full max-w-xs space-y-4"><input id="login-username" type="text" placeholder="Username" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500"><input id="login-password" type="password" placeholder="Password" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500"><button id="sign-in-btn" class="w-full py-2 bg-purple-600 hover:bg-purple-700 rounded-md text-white font-semibold transition-colors">Sign In</button><p class="text-center text-sm text-gray-400">No account? <button id="show-create-account-btn" class="text-purple-400 hover:underline">Create one</button></p></div>
        </div>
        <div id="create-account-view" class="hidden">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Create Account</h2>
            <div class="w-full max-w-xs space-y-4"><input id="create-username" type="text" placeholder="Username" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500"><input id="create-password" type="password" placeholder="Password" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500"><button id="create-account-btn" class="w-full py-2 bg-green-600 hover:bg-green-700 rounded-md text-white font-semibold transition-colors">Create Account</button><p class="text-center text-sm text-gray-400">Already have an account? <button id="show-login-btn" class="text-purple-400 hover:underline">Sign In</button></p></div>
        </div>
    </div>
    
    <div id="disclaimer-modal" class="hidden absolute inset-0 z-[60] flex items-center justify-center bg-black/50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm text-center animate-open">
            <h3 class="font-bold text-lg text-white mb-2">Disclaimer</h3>
            <p class="text-sm text-gray-300 mb-4">The images in this concept are placeholders used by the creator. All other elements, logic, and designs are generated by an AI. This is a conceptual demonstration and not a final product.</p>
            <button id="disclaimer-ok-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-md text-white font-semibold">Got it</button>
        </div>
    </div>

    <div id="desktop" class="h-screen w-screen relative overflow-hidden opacity-0">
        <main class="p-6">
            <div id="clock-container" class="inline-block cursor-pointer" tabindex="0" role="button" aria-label="Open time settings">
                <div id="clock" class="font-orbitron text-5xl font-bold text-white text-shadow text-right mb-6"></div>
            </div>
        </main>
        <div id="context-menu" class="hidden absolute w-56 bg-white/70 dark:bg-black/70 backdrop-blur-md rounded-lg shadow-2xl border border-white/30 dark:border-black/30 p-2 z-50 text-sm animate-open">
            <a href="#" id="open-settings-context" class="flex items-center space-x-2 px-2 py-2 hover:bg-white/50 dark:hover:bg-black/50 rounded-md cursor-pointer"><span class="material-symbols-outlined">tune</span><span>Personalize</span></a>
        </div>
        <div id="file-explorer-context-menu" class="hidden absolute w-56 bg-white/70 dark:bg-black/70 backdrop-blur-md rounded-lg shadow-2xl border border-white/30 dark:border-black/30 p-2 z-50 text-sm animate-open">
            <a href="#" id="fe-rename-context" class="flex items-center space-x-2 px-2 py-2 hover:bg-white/50 dark:hover:bg-black/50 rounded-md cursor-pointer"><span class="material-symbols-outlined">edit</span><span>Rename</span></a>
            <a href="#" id="fe-delete-context" class="flex items-center space-x-2 px-2 py-2 hover:bg-red-500/50 dark:hover:bg-red-500/50 rounded-md cursor-pointer text-red-400"><span class="material-symbols-outlined">delete</span><span>Delete</span></a>
        </div>
        <div id="start-menu" class="hidden absolute bottom-24 left-1/2 -translate-x-1/2 w-full max-w-2xl p-4 glassmorphism rounded-lg shadow-2xl animate-open z-40 flex flex-col">
             <div class="flex-grow grid grid-cols-3 gap-4">
                 <div class="text-center flex flex-col justify-between"><h4 class="font-bold text-lg mb-4">Updates</h4><a href="#" class="start-menu-app-icon flex items-center space-x-3 p-2 rounded-md hover:bg-white/30 dark:hover:bg-black/30 transition-colors" data-window="updates-window"><span class="material-symbols-outlined text-green-400">update</span><span>Update Center</span></a></div>
                 <div class="text-center"><h4 class="font-bold text-lg mb-4">Quick Access</h4>
                    <div id="quick-access-content" class="space-y-2 text-left px-2">
                        <p class="text-sm text-gray-400">No recent files.</p>
                    </div>
                 </div>
                 <div><h4 class="font-bold text-lg mb-4">Pinned Apps</h4><div class="space-y-2">
                    <a href="#" class="start-menu-app-icon flex items-center space-x-3 p-2 rounded-md hover:bg-white/30 dark:hover:bg-black/30 transition-colors" data-window="file-explorer-window"><span class="material-symbols-outlined text-yellow-500">folder</span><span>File Explorer</span></a>
                    <a href="#" class="start-menu-app-icon flex items-center space-x-3 p-2 rounded-md hover:bg-white/30 dark:hover:bg-black/30 transition-colors" data-window="terminal-window"><span class="material-symbols-outlined">terminal</span><span>Terminal</span></a>
                    <a href="#" class="start-menu-app-icon flex items-center space-x-3 p-2 rounded-md hover:bg-white/30 dark:hover:bg-black/30 transition-colors" data-window="text-editor-window"><span class="material-symbols-outlined text-lime-400">edit_note</span><span>Notepad</span></a>
                    <a href="#" class="start-menu-app-icon flex items-center space-x-3 p-2 rounded-md hover:bg-white/30 dark:hover:bg-black/30 transition-colors" data-window="settings-window"><span class="material-symbols-outlined">settings</span><span>Settings</span></a>
                    <a href="#" class="start-menu-app-icon flex items-center space-x-3 p-2 rounded-md hover:bg-white/30 dark:hover:bg-black/30 transition-colors" data-window="cpu-monitor-window"><span class="material-symbols-outlined text-purple-400">developer_board</span><span>CPU Monitor</span></a>
                </div></div>
            </div>
            <div class="flex items-center justify-between p-2 mt-4 border-t border-white/20 dark:border-black/20">
                <div class="flex items-center space-x-3">
                    <img src="https://placehold.co/40x40/7c3aed/ffffff?text=U" class="rounded-full w-10 h-10 border border-purple-500">
                    <span id="start-menu-username" class="font-semibold text-white">User</span>
                </div>
                <div class="relative">
                    <button id="power-options-btn" class="p-2 rounded-full hover:bg-white/20 dark:hover:bg-black/20 transition-colors">
                        <span class="material-symbols-outlined">power_settings_new</span>
                    </button>
                    <div id="power-options-menu" class="hidden absolute bottom-12 right-0 w-32 bg-white/70 dark:bg-black/70 backdrop-blur-md rounded-lg shadow-xl p-2 text-sm">
                        <a href="#" id="sign-out-btn" class="flex items-center space-x-2 px-2 py-1 hover:bg-white/50 dark:hover:bg-black/50 rounded-md cursor-pointer"><span class="material-symbols-outlined">logout</span><span>Sign Out</span></a>
                        <a href="#" id="restart-btn" class="flex items-center space-x-2 px-2 py-1 hover:bg-white/50 dark:hover:bg-black/50 rounded-md cursor-pointer"><span class="material-symbols-outlined">refresh</span><span>Restart</span></a>
                    </div>
                </div>
            </div>
        </div>
        <div id="windows-container" class="absolute inset-0 w-full h-full pointer-events-none">
            <div id="settings-window" class="window hidden absolute top-1/4 left-1/4 w-full max-w-2xl glassmorphism rounded-lg shadow-2xl flex flex-col animate-open pointer-events-auto overflow-hidden">
                <div class="title-bar flex items-center justify-between p-2 border-b border-white/30 dark:border-black/30">
                    <div class="flex items-center space-x-2"><span class="material-symbols-outlined">settings</span><span>Settings</span></div>
                    <button class="close-btn p-1 rounded-full hover:bg-red-500 hover:text-white transition-colors" data-window="settings-window"><span class="material-symbols-outlined">close</span></button>
                </div>
                <div class="flex flex-grow">
                    <div class="w-1/3 p-4 border-r border-white/20 dark:border-black/20 overflow-y-auto">
                        <h4 class="font-semibold mb-2">System</h4>
                        <a href="#about" class="settings-tab block p-2 rounded-lg hover:bg-white/20 dark:hover:bg-black/20" data-content-id="about-content">About</a>
                        <h4 class="font-semibold mb-2 mt-4">Personalization</h4>
                        <a href="#background" class="settings-tab block p-2 rounded-lg hover:bg-white/20 dark:hover:bg-black/20" data-content-id="background-content">Background</a>
                        <h4 class="font-semibold mb-2 mt-4">Account</h4>
                        <a href="#account" class="settings-tab block p-2 rounded-lg hover:bg-white/20 dark:hover:bg-black/20" data-content-id="account-content">Your Info</a>
                    </div>
                    <div class="w-2/3 p-4 overflow-y-auto">
                        <div id="about-content" class="settings-content">
                            <h4 class="font-semibold mb-2">About this PC</h4>
                            <div class="space-y-2 text-sm">
                                <div><strong>Device Name:</strong> Win13-Concept</div>
                                <div><strong>Processor:</strong> Virtual Core Gen 1</div>
                                <div><strong>Installed RAM:</strong> 16.0 GB</div>
                                <div><strong>OS Build:</strong> 23456.1</div>
                            </div>
                        </div>
                        <div id="background-content" class="settings-content hidden">
                            <h4 class="font-semibold mb-2">Background</h4>
                            <div class="flex flex-col space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Desktop Background Image:</label>
                                    <div class="flex space-x-4">
                                        <button id="set-light-bg" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-md text-white font-semibold transition-colors">Light Theme</button>
                                        <button id="set-dark-bg" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-md text-white font-semibold transition-colors">Dark Theme</button>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <label for="bgColorPicker" class="block text-sm font-medium">Custom Color (overrides image)</label>
                                    <input type="color" id="bgColorPicker" class="w-10 h-10 rounded-md cursor-pointer border-none bg-transparent">
                                </div>
                            </div>
                        </div>
                        <div id="account-content" class="settings-content hidden">
                            <h4 class="font-semibold mb-2">Account</h4>
                            <div class="flex items-center space-x-4">
                                <img src="https://placehold.co/64x64/7c3aed/ffffff?text=U" class="rounded-full w-16 h-16">
                                <div id="account-username" class="font-semibold">User</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="resize-handle"></div>
            </div>
            <div id="file-explorer-window" class="window hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl h-96 glassmorphism rounded-lg shadow-2xl flex flex-col animate-open pointer-events-auto overflow-hidden">
                <div class="title-bar flex items-center justify-between p-2 border-b border-white/30 dark:border-black/30">
                    <div class="flex items-center space-x-2"><span class="material-symbols-outlined text-yellow-500">folder</span><span>File Explorer</span></div>
                    <div class="flex items-center">
                        <button id="new-file-btn" class="p-1 rounded-full hover:bg-white/20"><span class="material-symbols-outlined">note_add</span></button>
                        <button class="close-btn p-1 rounded-full hover:bg-red-500 hover:text-white transition-colors" data-window="file-explorer-window"><span class="material-symbols-outlined">close</span></button>
                    </div>
                </div>
                <div id="file-explorer-output" class="p-4 flex-grow overflow-y-auto grid grid-cols-4 gap-4 content-start"></div>
                <div class="resize-handle"></div>
            </div>
            <div id="terminal-window" class="window hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl h-96 glassmorphism rounded-lg shadow-2xl flex flex-col animate-open pointer-events-auto overflow-hidden">
                <div class="title-bar flex items-center justify-between p-2 border-b border-white/30 dark:border-black/30">
                    <div class="flex items-center space-x-2"><span class="material-symbols-outlined">terminal</span><span>Terminal</span></div>
                    <button class="close-btn p-1 rounded-full hover:bg-red-500 hover:text-white transition-colors" data-window="terminal-window"><span class="material-symbols-outlined">close</span></button>
                </div>
                <div id="terminal-output" class="p-4 flex-grow bg-black/80 font-mono text-white text-sm overflow-y-auto" onclick="document.getElementById('terminal-input')?.focus()"></div>
                <div class="resize-handle"></div>
            </div>
            
            <div id="text-editor-window" class="window hidden absolute top-1/4 left-1/4 w-1/2 h-1/2 glassmorphism rounded-lg shadow-2xl flex flex-col animate-open pointer-events-auto overflow-hidden">
                <div class="title-bar flex items-center justify-between p-2 border-b border-white/30 dark:border-black/30">
                    <div class="flex items-center space-x-2">
                        <span class="material-symbols-outlined" id="text-editor-icon"></span>
                        <span id="text-editor-title"></span>
                    </div>
                    <div class="flex items-center">
                        <button id="save-file-btn" class="p-1 rounded-full hover:bg-white/20 hover:text-green-400 transition-colors mr-2">
                            <span class="material-symbols-outlined">save</span>
                        </button>
                        <button class="close-btn p-1 rounded-full hover:bg-red-500 hover:text-white transition-colors" data-window="text-editor-window">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                </div>
                <textarea id="text-editor-textarea" class="w-full h-full p-2 bg-gray-900 text-white font-mono outline-none resize-none"></textarea>
                <div class="resize-handle"></div>
            </div>

            <div id="updates-window" class="window hidden absolute top-1/4 left-1/4 w-full max-w-lg max-h-[90vh] glassmorphism rounded-lg shadow-2xl flex flex-col animate-open pointer-events-auto overflow-hidden">
                <div class="title-bar flex items-center justify-between p-2 border-b border-white/30 dark:border-black/30">
                    <div class="flex items-center space-x-2"><span class="material-symbols-outlined text-green-400">update</span><span>Update Center</span></div>
                    <button class="close-btn p-1 rounded-full hover:bg-red-500 hover:text-white transition-colors" data-window="updates-window"><span class="material-symbols-outlined">close</span></button>
                </div>
                <div class="flex flex-grow">
                    <div class="w-1/3 p-4 border-r border-white/20 dark:border-black/20 overflow-y-auto">
                        <a href="#updates" class="updates-tab block p-2 rounded-lg hover:bg-white/20 dark:hover:bg-black/20" data-content-id="updates-list-content">Updates</a>
                        <a href="#disclaimer" class="updates-tab block p-2 rounded-lg hover:bg-white/20 dark:hover:bg-black/20" data-content-id="updates-disclaimer-content">Disclaimer</a>
                    </div>
                    <div class="w-2/3 p-4 overflow-y-auto">
                        <div id="updates-list-content" class="updates-content">
                            <!-- Update 1.0.0 -->
                            <h3 class="font-bold text-lg mb-2">Windows 13 Restore Realized</h3>
                            <p class="text-sm">Version 1.0.0</p>
                            <p class="mt-2 text-sm">Welcome to the first major feature update for the Windows 13 Concept. This release focuses on fundamental system improvements and new core applications:</p>
                            <ul class="list-disc list-inside text-sm mt-2 space-y-1">
                                <li>**Window Resizing:** Windows are now resizable, offering greater flexibility in workspace management.</li>
                                <li>**Interactive File System:** A fully functional File Explorer allows for intuitive navigation and basic file operations (create files).</li>
                                <li>**Text Editor (Notepad):** Introduction of a versatile text editor supporting both `.txt` and `.py` file types.</li>
                                <li>**CPU Monitor & Simulator:** A new application to monitor virtual CPU registers and memory, with the ability to load and execute simple assembly-like programs.</li>
                                <li>**Enhanced Dock & Start Menu:** Improved accessibility for key applications directly from the dock and an updated Start Menu.</li>
                                <li>**Theming Options:** Easily switch between light and dark desktop themes.</li>
                                <li>**Basic Terminal Functionality:** Expanded commands for system interaction.</li>
                            </ul>
                            <p class="mt-4 text-sm font-semibold mb-6 pb-4 border-b border-white/20">Summary: This update lays the groundwork for a more interactive and feature-rich operating system concept, bringing essential tools and improved user experience.</p>
                            
                            <!-- New Update 1.0.5 -->
                            <h3 class="font-bold text-lg mb-2 mt-6">Windows + Linux Functionality & Supported Files</h3>
                            <p class="text-sm">Version 1.0.5</p>
                            <p class="mt-2 text-sm">This update further enhances the hybrid OS experience by integrating more command-line tools and improving file handling, offering a powerful blend of Windows and Linux features:</p>
                            <ul class="list-disc list-inside text-sm mt-2 space-y-1">
                                <li>**Expanded Terminal Commands:** Added common Linux commands like `pwd` (print working directory), `echo`, `whoami`, and `date` to the terminal for greater versatility.</li>
                                <li>**Improved File System Navigation:** The `cd` command in the terminal now supports absolute paths (e.g., `/C:/Users/You/Documents`) and more robust relative path handling.</li>
                                <li>**Enhanced File Operations:** Terminal `rm` command now includes a basic check for non-empty directories (though it only supports removing empty ones for simplicity).</li>
                                <li>**Unified Text Editor:** The "Notepad" app now intelligently adapts its title and icon based on the file extension (.txt for Notepad, .py for Code Editor), providing a more cohesive experience. The editor styling also includes a subtle "Linux" hint through its dark background and monospace font, reminiscent of popular Linux text editors.</li>
                                <li>**Context Menu Integration:** Right-clicking on the desktop now brings up a context menu with quick links to personalization settings, mirroring a classic desktop experience.</li>
                                <li>**Interactive Clock:** The desktop clock is now clickable, directly opening the "About" section in the Settings application.</li>
                            </ul>
                            <p class="mt-4 text-sm font-semibold mb-6 pb-4 border-b border-white/20">Summary: Version 1.0.5 deepens the hybrid OS feel by bringing more Linux-like command-line power and enhancing core application usability, making the system more flexible and powerful.</p>

                            <!-- New Update: Login Functionality -->
                            <h3 class="font-bold text-lg mb-2 mt-6">Updated Login and Account Management</h3>
                            <p class="text-sm">Version 1.0.6</p>
                            <p class="mt-2 text-sm">This update significantly enhances user account security and management:</p>
                            <ul class="list-disc list-inside text-sm mt-2 space-y-1">
                                <li>**Password Encryption:** User passwords are now securely hashed using SHA-256 before being stored, providing improved data protection.</li>
                                <li>**Multi-User Support:** The system now supports multiple user accounts stored in a client-side database (`localStorage`).</li>
                                <li>**Persistent Usernames:** Upon logout, the user's password is "shut down" (cleared) from storage for security, but their username remains, allowing for easier re-login or account recovery (recovery not implemented).</li>
                            </ul>
                            <p class="mt-4 text-sm font-semibold">Summary: Version 1.0.6 introduces enhanced login security and a more robust multi-user account system for a more personalized and secure experience.</p>
                        </div>
                        <div id="updates-disclaimer-content" class="updates-content hidden">
                            <h3 class="font-bold text-lg mb-2">Content Disclaimer</h3>
                            <p class="text-sm">Please note that all images and graphical assets used in this Windows 13 Concept demonstration were created by the original developer.</p>
                            <p class="mt-2 text-sm">However, all other elements, including the core logic, application functionality, layout designs, and descriptive text (such as this disclaimer and update notes), have been generated by an AI (Gemini).</p>
                            <p class="mt-4 text-sm font-semibold">This project serves as a conceptual prototype to showcase the potential of AI-assisted development in creating interactive user interfaces.</p>
                        </div>
                    </div>
                </div>
                <div class="resize-handle"></div>
            </div>
            
            <div id="cpu-monitor-window" class="window hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-3xl h-[600px] glassmorphism rounded-lg shadow-2xl flex flex-col animate-open pointer-events-auto overflow-hidden">
                <div class="title-bar flex items-center justify-between p-2 border-b border-white/30 dark:border-black/30">
                    <div class="flex items-center space-x-2"><span class="material-symbols-outlined text-purple-400">developer_board</span><span>CPU Monitor</span></div>
                    <button class="close-btn p-1 rounded-full hover:bg-red-500 hover:text-white transition-colors" data-window="cpu-monitor-window"><span class="material-symbols-outlined">close</span></button>
                </div>
                <div class="flex flex-grow p-4 space-x-4 overflow-hidden">
                    <div class="w-1/2 flex flex-col bg-white/10 dark:bg-black/10 rounded-md p-4 overflow-y-auto">
                        <h3 class="font-bold text-lg mb-4 text-white">CPU Registers</h3>
                        <div id="cpu-registers" class="grid grid-cols-2 gap-2 text-sm">
                            </div>
                        <h3 class="font-bold text-lg mt-6 mb-4 text-white">Program Editor</h3>
                        <textarea id="program-editor" class="w-full flex-grow bg-gray-900 text-white font-mono text-sm p-2 rounded-md resize-none" placeholder="Enter CPU program instructions here..."></textarea>
                        <div class="flex space-x-2 mt-4">
                            <button id="load-program-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md text-white font-semibold transition-colors">Load Program</button>
                            <button id="run-program-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-md text-white font-semibold transition-colors">Run Program</button>
                            <button id="step-program-btn" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-md text-white font-semibold transition-colors">Step</button>
                            <button id="reset-cpu-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-md text-white font-semibold transition-colors">Reset CPU/Mem</button>
                        </div>
                    </div>
                    <div class="w-1/2 flex flex-col bg-white/10 dark:bg-black/10 rounded-md p-4 overflow-y-auto">
                        <h3 class="font-bold text-lg mb-4 text-white">Memory (RAM)</h3>
                        <div id="memory-display" class="font-mono text-xs grid grid-cols-4 gap-1">
                            </div>
                    </div>
                </div>
                <div class="resize-handle"></div>
            </div>
        </div>
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex items-center space-x-2 p-2 glassmorphism rounded-2xl shadow-lg z-30"><button id="start-menu-btn" class="dock-icon h-14 w-14 flex items-center justify-center bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-all transform hover:scale-110"><span class="material-symbols-outlined text-3xl">widgets</span></button><div class="h-10 w-px bg-white/20"></div><button class="dock-icon h-14 w-14 flex items-center justify-center rounded-xl hover:bg-white/20 transition-all transform hover:scale-110" data-window="file-explorer-window"><span class="material-symbols-outlined text-3xl text-yellow-500">folder</span></button><button class="dock-icon h-14 w-14 flex items-center justify-center rounded-xl hover:bg-white/20 transition-all transform hover:scale-110" data-window="terminal-window"><span class="material-symbols-outlined text-3xl">terminal</span></button><button class="dock-icon h-14 w-14 flex items-center justify-center rounded-xl hover:bg-white/20 transition-all transform hover:scale-110" data-window="text-editor-window"><span class="material-symbols-outlined text-3xl text-lime-400">edit_note</span></button><button class="dock-icon h-14 w-14 flex items-center justify-center rounded-xl hover:bg-white/20 transition-all transform hover:scale-110" data-window="settings-window"><span class="material-symbols-outlined text-3xl">settings</span></button><button class="dock-icon h-14 w-14 flex items-center justify-center rounded-xl hover:bg-white/20 transition-all transform hover:scale-110" data-window="cpu-monitor-window"><span class="material-symbols-outlined text-3xl text-purple-400">developer_board</span></button><div class="h-10 w-px bg-white/20"></div><div class="flex items-center bg-black/20 rounded-full"><button id="theme-light-btn" class="dock-icon h-12 w-12 flex items-center justify-center rounded-full"><span class="material-symbols-outlined text-yellow-400">light_mode</span></button><button id="theme-dark-btn" class="dock-icon h-12 w-12 flex items-center justify-center rounded-full"><span class="material-symbols-outlined">dark_mode</span></button></div><button id="toggle-scrollbars-btn" class="dock-icon h-14 w-14 flex items-center justify-center rounded-xl hover:bg-white/20 transition-all transform hover:scale-110"><span class="material-symbols-outlined text-3xl">reorder</span></button></div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- VFS & State Management ---
        // VFS (Virtual File System) structure. Each key is a folder or file.
        // Files store their content directly as strings.
        let vfs = {
            'C:': {
                'Users': {
                    'You': {
                        'Desktop': {
                            'welcome.txt': 'Welcome to Windows 13 Concept! This is a simple text file. You can create more .txt or .py files using the "New File" button in File Explorer.',
                            'hello.py': 'print("Hello, Windows 13!")\\n\\ndef greet(name):\\n    return f"Hello, {name}!"\\n\\nprint(greet("AI User"))'
                        },
                        'Documents': {}
                    }
                }
            }
        };
        let currentPath = "C:/Users/You/Desktop";
        let currentOpenFile = { path: null, name: null }; // Tracks the file currently open in the text editor
        let recentFiles = JSON.parse(localStorage.getItem('recentFiles')) || []; // Load recent files from local storage
        let activeUser = localStorage.getItem('win13_active_user'); // Track currently logged-in user

        // --- DOM Elements ---
        const loginContainer = document.getElementById('login-container');
        const loginView = document.getElementById('login-view');
        const createAccountView = document.getElementById('create-account-view');
        const signInBtn = document.getElementById('sign-in-btn');
        const showCreateAccountBtn = document.getElementById('show-create-account-btn');
        const showLoginBtn = document.getElementById('show-login-btn');
        const createAccountBtn = document.getElementById('create-account-btn');
        const disclaimerModal = document.getElementById('disclaimer-modal');
        const disclaimerOkBtn = document.getElementById('disclaimer-ok-btn');
        const desktop = document.getElementById('desktop');
        const bootSound = document.getElementById('boot-sound');
        const fileExplorerOutput = document.getElementById('file-explorer-output');
        const newFileBtn = document.getElementById('new-file-btn');
        const terminalOutput = document.getElementById('terminal-output');
        const cpuRegistersDisplay = document.getElementById('cpu-registers');
        const memoryDisplay = document.getElementById('memory-display');
        const programEditor = document.getElementById('program-editor');
        const loadProgramBtn = document.getElementById('load-program-btn');
        const runProgramBtn = document.getElementById('run-program-btn');
        const stepProgramBtn = document.getElementById('step-program-btn');
        const resetCpuBtn = document.getElementById('reset-cpu-btn');

        // Text Editor DOM elements
        const textEditorWindow = document.getElementById('text-editor-window');
        const textEditorTitle = document.getElementById('text-editor-title');
        const textEditorIcon = document.getElementById('text-editor-icon');
        const textEditorTextarea = document.getElementById('text-editor-textarea');
        const saveFileBtn = document.getElementById('save-file-btn');

        // Context Menu DOM elements
        const desktopContextMenu = document.getElementById('context-menu'); // Renamed for clarity
        const openSettingsContextBtn = document.getElementById('open-settings-context');
        const fileExplorerContextMenu = document.getElementById('file-explorer-context-menu'); // New file explorer context menu
        const feRenameContextBtn = document.getElementById('fe-rename-context');
        const feDeleteContextBtn = document.getElementById('fe-delete-context');
        let activeFileExplorerItem = null; // To store the path of the item right-clicked in FE

        // Clock DOM elements
        const clockElement = document.getElementById('clock');
        const clockContainer = document.getElementById('clock-container');

        // Settings DOM elements
        const settingsTabs = document.querySelectorAll('.settings-tab');
        const settingsContents = document.querySelectorAll('.settings-content');
        const setLightBgBtn = document.getElementById('set-light-bg');
        const setDarkBgBtn = document.getElementById('set-dark-bg');
        const bgColorPicker = document.getElementById('bgColorPicker');

        // Start Menu Quick Access
        const quickAccessContent = document.getElementById('quick-access-content');
        const startMenuBtn = document.getElementById('start-menu-btn');
        const startMenu = document.getElementById('start-menu');
        const startMenuUsername = document.getElementById('start-menu-username');
        const powerOptionsBtn = document.getElementById('power-options-btn');
        const powerOptionsMenu = document.getElementById('power-options-menu');
        const signOutBtn = document.getElementById('sign-out-btn');
        const restartBtn = document.getElementById('restart-btn');


        // Update Center Tabs
        const updatesTabs = document.querySelectorAll('.updates-tab');
        const updatesContents = document.querySelectorAll('.updates-content');

        // Scrollbar toggle button
        const toggleScrollbarsBtn = document.getElementById('toggle-scrollbars-btn');

        // --- Custom Message Box Functions ---
        const messageBox = document.getElementById('message-box');
        const messageBoxTitle = document.getElementById('message-box-title');
        const messageBoxContent = document.getElementById('message-box-content');
        const messageBoxOkBtn = document.getElementById('message-box-ok-btn');

        const showMessageBox = (title, message, onOk) => {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = message;
            messageBox.classList.remove('hidden');
            messageBoxOkBtn.onclick = () => {
                messageBox.classList.add('hidden');
                if (onOk) onOk();
            };
        };
        
        const showConfirmBox = (title, message, onConfirm, onCancel) => {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = message;
            messageBox.classList.remove('hidden');
            // Add a cancel button for confirmation
            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancel';
            cancelButton.className = 'px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-md text-white font-semibold ml-2';
            messageBox.querySelector('.bg-gray-800').appendChild(cancelButton);

            messageBoxOkBtn.textContent = 'Confirm'; // Change OK to Confirm
            messageBoxOkBtn.onclick = () => {
                messageBox.classList.add('hidden');
                messageBox.querySelector('.bg-gray-800').removeChild(cancelButton); // Clean up
                if (onConfirm) onConfirm();
            };
            cancelButton.onclick = () => {
                messageBox.classList.add('hidden');
                messageBox.querySelector('.bg-gray-800').removeChild(cancelButton); // Clean up
                if (onCancel) onCancel();
            };
        };

        // --- Hashing Function (SHA-256) ---
        async function hashString(str) {
            const textEncoder = new TextEncoder();
            const data = textEncoder.encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hexHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            console.log(`[LOGIN/DB] Hashing: '${str}' -> '${hexHash}'`); // Log hashing process
            return hexHash;
        }

        // --- Account & Login ---
        const loadUsers = () => {
            const usersJson = localStorage.getItem('win13_users');
            const users = usersJson ? JSON.parse(usersJson) : {};
            console.log("[LOGIN/DB] Loaded users:", JSON.stringify(users, null, 2)); // Log loaded users with pretty print
            return users;
        };

        const saveUsers = (users) => {
            localStorage.setItem('win13_users', JSON.stringify(users));
            console.log("[LOGIN/DB] Saved users:", JSON.stringify(users, null, 2)); // Log saved users with pretty print
        };

        showCreateAccountBtn.addEventListener('click', () => { 
            loginView.classList.add('hidden'); 
            createAccountView.classList.remove('hidden'); 
            console.log("[LOGIN] Switched to Create Account view.");
        });
        showLoginBtn.addEventListener('click', () => { 
            createAccountView.classList.add('hidden'); 
            loginView.classList.remove('hidden'); 
            console.log("[LOGIN] Switched to Login view.");
        });
        
        createAccountBtn.addEventListener('click', async () => {
            const user = document.getElementById('create-username').value;
            const pass = document.getElementById('create-password').value;

            if (user && pass) { 
                let users = loadUsers();
                if (users[user]) {
                    showMessageBox('Registration Failed', 'Username already exists. Please choose a different username.');
                    console.warn(`[LOGIN] Registration failed: Username '${user}' already exists.`); // Log registration failure
                    return;
                }
                const hashedPassword = await hashString(pass);
                users[user] = { hashedPassword: hashedPassword };
                saveUsers(users);
                showMessageBox('Account Created', 'Your account has been successfully created! You can now sign in.'); 
                console.log(`[LOGIN/DB] Account for '${user}' created successfully.`); // Log registration success
                showLoginBtn.click(); 
            } else { 
                showMessageBox('Error', 'Please enter a username and password.'); 
                console.error("[LOGIN] Registration failed: Username or password missing."); // Log missing fields
            }
        });

        signInBtn.addEventListener('click', async () => {
            const user = document.getElementById('login-username').value;
            const pass = document.getElementById('login-password').value;
            const users = loadUsers();

            if (users[user]) {
                const storedHashedPassword = users[user].hashedPassword;
                const enteredHashedPassword = await hashString(pass);

                if (storedHashedPassword && enteredHashedPassword === storedHashedPassword) {
                    localStorage.setItem('win13_active_user', user); // Set active user
                    document.getElementById('account-username').textContent = user;
                    startMenuUsername.textContent = user; 
                    bootSound.play().catch(e => { /* console.warn("Boot sound playback failed:", e); */ }); // Log boot sound error
                    loginContainer.style.opacity = '0';
                    setTimeout(() => {
                        loginContainer.classList.add('hidden');
                        desktop.style.opacity = '1';
                        if (!localStorage.getItem('win13_disclaimer_seen')) {
                            disclaimerModal.classList.remove('hidden');
                            console.log("[LOGIN] Showing disclaimer modal for first-time login.");
                        }
                    }, 500);
                    console.log(`[LOGIN] User '${user}' logged in successfully.`); // Log login success
                } else if (!storedHashedPassword) {
                    showMessageBox('Login Failed', 'No password set for this account. Please create a new account or contact support.');
                    console.warn(`[LOGIN] Login failed for '${user}': No password set for this account.`); // Log no password set
                }
                else { 
                    showMessageBox('Login Failed', 'Invalid password.'); 
                    console.warn(`[LOGIN] Login failed for '${user}': Invalid password.`); // Log invalid password
                }
            } else { 
                showMessageBox('Login Failed', 'Username not found. Create an account if you haven\'t.'); 
                console.warn(`[LOGIN] Login failed: Username '${user}' not found.`); // Log username not found
            }
        });

        disclaimerOkBtn.addEventListener('click', () => {
            disclaimerModal.classList.add('hidden');
            localStorage.setItem('win13_disclaimer_seen', 'true');
            // console.log("Disclaimer acknowledged."); // Removed non-login/DB log
        });

        // Initial check for active user
        if (activeUser) {
            loginContainer.classList.add('hidden');
            desktop.style.opacity = '1';
            document.getElementById('account-username').textContent = activeUser;
            startMenuUsername.textContent = activeUser;
            console.log(`[LOGIN] Active user '${activeUser}' automatically logged in.`);
        } else {
            const users = loadUsers();
            if (Object.keys(users).length === 0) {
                loginView.classList.add('hidden');
                createAccountView.classList.remove('hidden');
                console.log("[LOGIN] No users found, showing Create Account view.");
            } else {
                console.log("[LOGIN] No active user, showing Login view.");
            }
        }


        // --- File System & Explorer ---

        // Helper to navigate VFS object
        const getObjectFromPath = (path) => {
            const parts = path.split('/').filter(p => p !== '');
            let current = vfs;
            for (const part of parts) {
                if (current && current[part] !== undefined) {
                    current = current[part];
                } else {
                    return undefined;
                }
            }
            return current;
        };

        const getParentAndNameFromPath = (path) => {
            const parts = path.split('/').filter(p => p !== '');
            const name = parts.pop();
            const parentPath = parts.length > 0 ? parts.join('/') : (path.startsWith('C:') ? 'C:' : '');
            let parentObj = getObjectFromPath(parentPath);
            if (!parentObj && parentPath === 'C:') {
                parentObj = vfs['C:'];
            }
            return { parentObj, name, parentPath };
        };

        const deleteFileOrFolder = (fullPath, isDirectory) => {
            const { parentObj, name } = getParentAndNameFromPath(fullPath);
            if (!parentObj) {
                showMessageBox("Error", "Could not find parent directory.");
                // console.error(`Deletion failed: Could not find parent directory for '${fullPath}'.`); // Removed non-login/DB log
                return false;
            }

            if (isDirectory && Object.keys(parentObj[name]).length > 0) {
                showMessageBox("Error", `Directory '${name}' is not empty. Cannot delete.`);
                // console.warn(`Deletion failed: Directory '${name}' is not empty.`); // Removed non-login/DB log
                return false;
            }

            showConfirmBox(
                "Confirm Deletion",
                `Are you sure you want to delete '${name}'? This action cannot be undone.`,
                () => {
                    delete parentObj[name];
                    showMessageBox("Deleted", `'${name}' has been deleted.`);
                    // console.log(`'${name}' at '${fullPath}' deleted.`); // Removed non-login/DB log
                    renderFileExplorer();
                    recentFiles = recentFiles.filter(file => file.path !== fullPath);
                    localStorage.setItem('recentFiles', JSON.stringify(recentFiles));
                    renderQuickAccess();
                }
            );
            return true;
        };

        const renameFileOrFolder = (fullPath, oldName, isDirectory) => {
            const { parentObj, parentPath } = getParentAndNameFromPath(fullPath);
            if (!parentObj) {
                showMessageBox("Error", "Could not find parent directory.");
                // console.error(`Rename failed: Could not find parent directory for '${fullPath}'.`); // Removed non-login/DB log
                return false;
            }

            const newName = prompt(`Rename '${oldName}' to:`);
            if (newName && newName.trim() !== '' && newName !== oldName) {
                if (parentObj[newName] !== undefined) {
                    showMessageBox("Error", `A file or folder named '${newName}' already exists.`);
                    // console.warn(`Rename failed: A file or folder named '${newName}' already exists.`); // Removed non-login/DB log
                    return false;
                }

                parentObj[newName] = parentObj[oldName];
                delete parentObj[oldName];

                if (!isDirectory) {
                    const recentIndex = recentFiles.findIndex(file => file.path === fullPath);
                    if (recentIndex !== -1) {
                        recentFiles[recentIndex].name = newName;
                        recentFiles[recentIndex].path = `${parentPath}/${newName}`;
                        localStorage.setItem('recentFiles', JSON.stringify(recentFiles));
                        renderQuickAccess();
                    }
                }
                
                showMessageBox("Renamed", `'${oldName}' renamed to '${newName}'.`);
                // console.log(`'${oldName}' at '${fullPath}' renamed to '${newName}'.`); // Removed non-login/DB log
                renderFileExplorer();
                return true;
            } else if (newName !== null) {
                showMessageBox("Info", "Rename cancelled or new name is invalid/same.");
                // console.log("Rename cancelled or new name is invalid/same."); // Removed non-login/DB log
            }
            return false;
        };


        const renderFileExplorer = () => {
            fileExplorerOutput.innerHTML = '';
            const currentDir = getObjectFromPath(currentPath);
            if (!currentDir || typeof currentDir !== 'object') {
                showMessageBox("Error", "Invalid directory path.");
                // console.error(`File Explorer error: Invalid directory path '${currentPath}'.`); // Removed non-login/DB log
                return;
            }

            const pathParts = currentPath.split('/').filter(p => p !== '');
            if (pathParts.length > 1) {
                const upIcon = document.createElement('div');
                upIcon.className = 'flex flex-col items-center p-2 rounded-lg hover:bg-white/20 cursor-pointer';
                upIcon.innerHTML = `<span class="material-symbols-outlined text-5xl text-gray-400">arrow_upward</span><span class="text-xs text-center truncate w-full">..</span>`;
                upIcon.addEventListener('click', () => {
                    pathParts.pop();
                    currentPath = pathParts.length > 0 ? pathParts.join('/') : 'C:';
                    if (currentPath === 'C') currentPath = 'C:';
                    else if (!currentPath.startsWith('C:') && pathParts.length > 0) currentPath = 'C:/' + currentPath;
                    
                    renderFileExplorer();
                    // console.log(`Navigated up to: ${currentPath}`); // Removed non-login/DB log
                });
                fileExplorerOutput.appendChild(upIcon);
            } else if (pathParts.length === 1 && pathParts[0] !== 'C:') {
            }

            const sortedKeys = Object.keys(currentDir).sort((a, b) => {
                const isDirA = typeof currentDir[a] === 'object';
                const isDirB = typeof currentDir[b] === 'object';
                if (isDirA && !isDirB) return -1;
                if (!isDirA && isDirB) return 1;
                return a.localeCompare(b);
            });


            sortedKeys.forEach(key => {
                const isDir = typeof currentDir[key] === 'object';
                const icon = document.createElement('div');
                icon.className = 'flex flex-col items-center p-2 rounded-lg hover:bg-white/20 cursor-pointer';
                
                let materialIcon = '';
                let iconColor = '';
                if (isDir) {
                    materialIcon = 'folder';
                    iconColor = 'text-yellow-500';
                } else if (key.endsWith('.txt')) {
                    materialIcon = 'description';
                    iconColor = 'text-gray-300';
                } else if (key.endsWith('.py')) {
                    materialIcon = 'code';
                    iconColor = 'text-blue-400';
                } else {
                    materialIcon = 'insert_drive_file';
                    iconColor = 'text-gray-500';
                }

                icon.innerHTML = `<span class="material-symbols-outlined text-5xl ${iconColor}">${materialIcon}</span><span class="text-xs text-center truncate w-full">${key}</span>`;
                
                const fullPath = `${currentPath}/${key}`;

                icon.addEventListener('click', () => {
                    if (isDir) {
                        currentPath = fullPath;
                        renderFileExplorer();
                        // console.log(`Entered directory: ${currentPath}`); // Removed non-login/DB log
                    } else {
                        openFileInTextEditor(fullPath, key);
                    }
                });

                icon.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    activeFileExplorerItem = { path: fullPath, name: key, isDir: isDir };
                    fileExplorerContextMenu.style.left = `${e.clientX}px`;
                    fileExplorerContextMenu.style.top = `${e.clientY}px`;
                    fileExplorerContextMenu.classList.remove('hidden');
                    // console.log(`File Explorer context menu opened for '${key}'.`); // Removed non-login/DB log
                });

                fileExplorerOutput.appendChild(icon);
            });
        };

        feRenameContextBtn.addEventListener('click', (e) => {
            e.preventDefault();
            fileExplorerContextMenu.classList.add('hidden');
            if (activeFileExplorerItem) {
                // console.log(`Attempting to rename '${activeFileExplorerItem.name}'.`); // Removed non-login/DB log
                renameFileOrFolder(activeFileExplorerItem.path, activeFileExplorerItem.name, activeFileExplorerItem.isDir);
            }
        });

        feDeleteContextBtn.addEventListener('click', (e) => {
            e.preventDefault();
            fileExplorerContextMenu.classList.add('hidden');
            if (activeFileExplorerItem) {
                // console.log(`Attempting to delete '${activeFileExplorerItem.name}'.`); // Removed non-login/DB log
                deleteFileOrFolder(activeFileExplorerItem.path, activeFileExplorerItem.isDir);
            }
        });

        document.addEventListener('click', (e) => {
            if (!fileExplorerContextMenu.contains(e.target)) {
                fileExplorerContextMenu.classList.add('hidden');
                // console.log("File Explorer context menu hidden."); // Removed non-login/DB log
            }
        });


        const openFileInTextEditor = (filePath, fileName) => {
            const fileContent = getObjectFromPath(filePath);
            if (typeof fileContent === 'string') {
                textEditorTextarea.value = fileContent;
                textEditorTitle.textContent = fileName;

                if (fileName.endsWith('.py')) {
                    textEditorTitle.textContent = `Code Editor - ${fileName}`;
                    textEditorIcon.textContent = 'code';
                    textEditorIcon.classList.remove('text-lime-400');
                    textEditorIcon.classList.add('text-blue-400');
                } else if (fileName.endsWith('.txt')) {
                    textEditorTitle.textContent = `Notepad - ${fileName}`;
                    textEditorIcon.textContent = 'edit_note';
                    textEditorIcon.classList.remove('text-blue-400');
                    textEditorIcon.classList.add('text-lime-400');
                } else {
                    textEditorTitle.textContent = `Text Editor - ${fileName}`;
                    textEditorIcon.textContent = 'insert_drive_file';
                    textEditorIcon.classList.remove('text-blue-400', 'text-lime-400');
                    textEditorIcon.classList.add('text-gray-300');
                }
                
                currentOpenFile = { path: filePath, name: fileName };
                addRecentFile(filePath, fileName);
                openWindow('text-editor-window');
                // console.log(`Opened file '${fileName}' in text editor.`); // Removed non-login/DB log
            } else {
                showMessageBox("Error", "Could not open file: Not a valid file or path.");
                // console.error(`Failed to open file: '${filePath}' is not a valid file or path.`); // Removed non-login/DB log
            }
        };

        saveFileBtn.addEventListener('click', () => {
            if (currentOpenFile.path) {
                const parts = currentOpenFile.path.split('/');
                const fileName = parts.pop();
                const dirPath = parts.join('/');
                const currentDir = getObjectFromPath(dirPath);

                if (currentDir && typeof currentDir === 'object') {
                    currentDir[fileName] = textEditorTextarea.value;
                    showMessageBox("Saved", `File '${fileName}' saved successfully!`);
                    // console.log(`File '${fileName}' saved successfully.`); // Removed non-login/DB log
                    renderFileExplorer();
                } else {
                    showMessageBox("Error", "Could not determine save location.");
                    // console.error("Save failed: Could not determine save location for current file."); // Removed non-login/DB log
                }
            } else {
                showMessageBox("Error", "No file is currently open to save.");
                // console.warn("Save failed: No file open in text editor."); // Removed non-login/DB log
            }
        });

        newFileBtn.addEventListener('click', () => {
            const fileName = prompt("Enter file name (e.g., mydocument.txt, myscript.py):");
            if (fileName) {
                const lowerFileName = fileName.toLowerCase();
                if (lowerFileName.endsWith('.txt') || lowerFileName.endsWith('.py')) {
                    const currentDir = getObjectFromPath(currentPath);
                    if (currentDir) {
                        if (currentDir[fileName] !== undefined) {
                            showMessageBox("Error", `File '${fileName}' already exists.`);
                            // console.warn(`File creation failed: '${fileName}' already exists.`); // Removed non-login/DB log
                            return;
                        }
                        currentDir[fileName] = '';
                        renderFileExplorer();
                        showMessageBox("File Created", `File '${fileName}' created.`);
                        // console.log(`File '${fileName}' created at '${currentPath}'.`); // Removed non-login/DB log
                        openFileInTextEditor(`${currentPath}/${fileName}`, fileName);
                    } else {
                        showMessageBox("Error", "Could not create file: Invalid current directory.");
                        // console.error(`File creation failed: Invalid current directory '${currentPath}'.`); // Removed non-login/DB log
                    }
                } else {
                    showMessageBox("Invalid File Type", "Only .txt and .py files are supported for creation.");
                    // console.warn(`File creation failed: Invalid file type for '${fileName}'.`); // Removed non-login/DB log
                }
            } else {
                // console.log("File creation cancelled by user."); // Removed non-login/DB log
            }
        });

        // --- Terminal ---
        const processCommand = (cmd) => {
            // console.log(`Executing command: ${cmd.split(' ')[0]} with args: ${cmd.split(' ').slice(1).join(' ')}`); // Removed non-login/DB log
            const [command, ...args] = cmd.trim().split(' ');
            if (!command) return;
            const append = (text) => appendTerminalOutput(text);
            switch (command.toLowerCase()) {
                case 'mkdir':
                    if (!args[0]) { append("Usage: mkdir [directory_name]"); /* console.warn("mkdir: Missing directory name."); */ break; }
                    const newDirName = args[0];
                    const currentMkdirDir = getObjectFromPath(currentPath);
                    if (currentMkdirDir && typeof currentMkdirDir === 'object') { 
                        if (currentMkdirDir[newDirName] !== undefined) {
                            append(`Error: Directory '${newDirName}' already exists.`);
                            // console.warn(`mkdir: Directory '${newDirName}' already exists.`); // Removed non-login/DB log
                            break;
                        }
                        currentMkdirDir[newDirName] = {}; 
                        append(`Directory '${newDirName}' created.`); 
                        // console.log(`mkdir: Directory '${newDirName}' created.`); // Removed non-login/DB log
                        renderFileExplorer(); 
                    } else { 
                        append(`Error: Path not found or not a directory.`); 
                        // console.error(`mkdir: Path not found or not a directory for '${currentPath}'.`); // Removed non-login/DB log
                    }
                    break;
                case 'ls':
                    const dirToList = getObjectFromPath(currentPath);
                    if (dirToList && typeof dirToList === 'object') {
                        Object.keys(dirToList).sort().forEach(item => {
                            const isDir = typeof dirToList[item] === 'object';
                            append(`${isDir ? '[DIR]' : '[FILE]'} ${item}`);
                        });
                        // console.log(`ls: Listed contents of '${currentPath}'.`); // Removed non-login/DB log
                    } else {
                        append(`Error: Cannot list contents. Path not found or not a directory.`);
                        // console.error(`ls: Cannot list contents. Path not found or not a directory for '${currentPath}'.`); // Removed non-login/DB log
                    }
                    break;
                case 'cd':
                    if (!args[0]) { append("Usage: cd [directory_name] or cd .. or cd /path/to/dir"); /* console.warn("cd: Missing directory argument."); */ break; }
                    let targetPath = '';
                    if (args[0] === '..') {
                        const pathParts = currentPath.split('/').filter(p => p !== '');
                        if (pathParts.length > 1) {
                            pathParts.pop();
                            targetPath = pathParts.join('/');
                            if (!targetPath.startsWith('C:') && pathParts.length > 0) targetPath = 'C:/' + targetPath;
                            if (pathParts.length === 0) targetPath = 'C:';
                        } else {
                            append("Already at root.");
                            // console.log("cd: Already at root, cannot go up further."); // Removed non-login/DB log
                            break;
                        }
                    } else if (args[0].startsWith('/')) {
                        targetPath = args[0].substring(1);
                        if (!targetPath.startsWith('C:') && targetPath !== 'C:') {
                            targetPath = 'C:/' + targetPath;
                        }
                    } else {
                        targetPath = `${currentPath}/${args[0]}`;
                    }

                    targetPath = targetPath.replace(/\/\/+/g, '/');
                    if (targetPath === 'C') targetPath = 'C:';
                    else if (targetPath.endsWith(':') && targetPath.length > 1) { /* do nothing */ }
                    else if (!targetPath.startsWith('C:/') && targetPath.includes(':')) { /* do nothing */ }
                    else if (targetPath.includes(':') && !targetPath.includes('/')) { /* do nothing */ }
                    else if (!targetPath.startsWith('C:/') && !targetPath.endsWith(':')) {
                        targetPath = 'C:/' + targetPath;
                    }


                    const newDir = getObjectFromPath(targetPath);
                    if (newDir && typeof newDir === 'object') {
                        currentPath = targetPath;
                        append(`Changed directory to ${currentPath}`);
                        // console.log(`cd: Changed directory to '${currentPath}'.`); // Removed non-login/DB log
                        renderFileExplorer();
                    } else {
                        append(`Error: Directory '${args[0]}' not found or is a file.`);
                        // console.error(`cd: Directory '${args[0]}' not found or is a file.`); // Removed non-login/DB log
                    }
                    break;
                case 'cat':
                    if (!args[0]) { append("Usage: cat [file_name]"); /* console.warn("cat: Missing file name."); */ break; }
                    const filePath = `${currentPath}/${args[0]}`;
                    const fileContent = getObjectFromPath(filePath);
                    if (typeof fileContent === 'string') {
                        append(`--- Content of ${args[0]} ---`);
                        append(fileContent);
                        append(`--- End of file ---`);
                        // console.log(`cat: Displayed content of '${args[0]}'.`); // Removed non-login/DB log
                    } else {
                        append(`Error: File '${args[0]}' not found or is a directory.`);
                        // console.error(`cat: File '${args[0]}' not found or is a directory.`); // Removed non-login/DB log
                    }
                    break;
                case 'touch':
                    if (!args[0]) { append("Usage: touch [file_name]"); /* console.warn("touch: Missing file name."); */ break; }
                    const currentTouchDir = getObjectFromPath(currentPath);
                    const touchFileName = args[0];
                    if (currentTouchDir && typeof currentTouchDir === 'object') {
                        if (currentTouchDir[touchFileName] !== undefined) {
                            append(`Error: File '${touchFileName}' already exists.`);
                            // console.warn(`touch: File '${touchFileName}' already exists.`); // Removed non-login/DB log
                            break;
                        }
                        currentTouchDir[touchFileName] = '';
                        append(`File '${touchFileName}' created.`);
                        // console.log(`touch: File '${touchFileName}' created.`); // Removed non-login/DB log
                        renderFileExplorer();
                    } else {
                        append(`Error: Path not found.`);
                        // console.error(`touch: Path not found for '${currentPath}'.`); // Removed non-login/DB log
                    }
                    break;
                case 'rm':
                    if (!args[0]) { append("Usage: rm [file_or_dir_name] or rm -r [directory_name]"); /* console.warn("rm: Missing argument."); */ break; }
                    const rmOptions = args[0];
                    const rmTarget = args[1] || args[0];
                    const currentRmDir = getObjectFromPath(currentPath);
                    
                    if (!currentRmDir || typeof currentRmDir !== 'object') {
                        append(`Error: Current path not found or not a directory.`);
                        // console.error(`rm: Current path not found or not a directory.`); // Removed non-login/DB log
                        break;
                    }

                    if (rmOptions === '-r') {
                        const targetPath = `${currentPath}/${rmTarget}`;
                        const targetObj = getObjectFromPath(targetPath);

                        if (!targetObj) {
                            append(`Error: '${rmTarget}' not found.`);
                            // console.warn(`rm -r: Target '${rmTarget}' not found.`); // Removed non-login/DB log
                            break;
                        }

                        if (typeof targetObj === 'object') {
                            showConfirmBox(
                                "Confirm Recursive Deletion",
                                `Are you sure you want to recursively delete directory '${rmTarget}' and all its contents? This cannot be undone.`,
                                () => {
                                    const deleteRecursive = (obj, nameToDelete) => {
                                        if (obj[nameToDelete]) {
                                            delete obj[nameToDelete];
                                        }
                                    };
                                    deleteRecursive(currentRmDir, rmTarget);
                                    append(`Recursively removed '${rmTarget}'.`);
                                    // console.log(`rm -r: Recursively removed '${rmTarget}'.`); // Removed non-login/DB log
                                    renderFileExplorer();
                                }
                            );
                        } else {
                            showConfirmBox(
                                "Confirm Deletion",
                                `Are you sure you want to delete file '${rmTarget}'? This cannot be undone.`,
                                () => {
                                    delete currentRmDir[rmTarget];
                                    append(`Removed '${rmTarget}'.`);
                                    // console.log(`rm: Removed file '${rmTarget}'.`); // Removed non-login/DB log
                                    renderFileExplorer();
                                    recentFiles = recentFiles.filter(file => file.path !== targetPath);
                                    localStorage.setItem('recentFiles', JSON.stringify(recentFiles));
                                    renderQuickAccess();
                                }
                            );
                        }
                    } else {
                        if (currentRmDir[rmTarget] !== undefined) {
                            if (typeof currentRmDir[rmTarget] === 'object' && Object.keys(currentRmDir[rmTarget]).length > 0) {
                                append(`Error: Directory '${rmTarget}' is not empty. Use 'rm -r ${rmTarget}' to remove recursively.`);
                                // console.warn(`rm: Directory '${rmTarget}' not empty.`); // Removed non-login/DB log
                            } else {
                                showConfirmBox(
                                    "Confirm Deletion",
                                    `Are you sure you want to delete '${rmTarget}'? This cannot be undone.`,
                                    () => {
                                        delete currentRmDir[rmTarget];
                                        append(`Removed '${rmTarget}'.`);
                                        // console.log(`rm: Removed '${rmTarget}'.`); // Removed non-login/DB log
                                        renderFileExplorer();
                                        const targetPath = `${currentPath}/${rmTarget}`;
                                        recentFiles = recentFiles.filter(file => file.path !== targetPath);
                                        localStorage.setItem('recentFiles', JSON.stringify(recentFiles));
                                        renderQuickAccess();
                                    }
                                );
                            }
                        } else {
                            append(`Error: '${rmTarget}' not found.`);
                            // console.warn(`rm: Target '${rmTarget}' not found.`); // Removed non-login/DB log
                        }
                    }
                    break;
                case 'rmdir':
                    if (!args[0]) { append("Usage: rmdir [directory_name]"); /* console.warn("rmdir: Missing directory name."); */ break; }
                    const rmdirTarget = args[0];
                    const currentRmdirDir = getObjectFromPath(currentPath);

                    if (!currentRmdirDir || typeof currentRmdirDir !== 'object' || currentRmdirDir[rmdirTarget] === undefined) {
                        append(`Error: Directory '${rmdirTarget}' not found.`);
                        // console.warn(`rmdir: Directory '${rmdirTarget}' not found.`); // Removed non-login/DB log
                        break;
                    }
                    if (typeof currentRmdirDir[rmdirTarget] !== 'object') {
                        append(`Error: '${rmdirTarget}' is a file, not a directory.`);
                        // console.warn(`rmdir: '${rmdirTarget}' is a file, not a directory.`); // Removed non-login/DB log
                        break;
                    }
                    if (Object.keys(currentRmdirDir[rmdirTarget]).length > 0) {
                        append(`Error: Directory '${rmdirTarget}' is not empty.`);
                        // console.warn(`rmdir: Directory '${rmdirTarget}' is not empty.`); // Removed non-login/DB log
                        break;
                    }

                    showConfirmBox(
                        "Confirm Directory Deletion",
                        `Are you sure you want to delete empty directory '${rmdirTarget}'?`,
                        () => {
                            delete currentRmdirDir[rmdirTarget];
                            append(`Removed directory '${rmdirTarget}'.`);
                            // console.log(`rmdir: Removed directory '${rmdirTarget}'.`); // Removed non-login/DB log
                            renderFileExplorer();
                        }
                    );
                    break;
                case 'clear':
                    terminalOutput.innerHTML = '';
                    // console.log("Terminal cleared."); // Removed non-login/DB log
                    break;
                case 'ps':
                    append("PID | Window Title");
                    append("------------------");
                    document.querySelectorAll('.window:not(.hidden)').forEach((win, index) => {
                        const titleBar = win.querySelector('.title-bar > div > span:last-child');
                        const title = titleBar ? titleBar.textContent : 'Unnamed Window';
                        append(`${String(index + 1).padStart(3, '0')} | ${title} (ID: ${win.id})`);
                    });
                    // console.log("Displayed list of active processes/windows."); // Removed non-login/DB log
                    break;
                case 'kill':
                    if (!args[0]) { append("Usage: kill [window_id]"); /* console.warn("kill: Missing window ID."); */ break; }
                    const windowToKill = document.getElementById(args[0]);
                    if (windowToKill && !windowToKill.classList.contains('hidden')) {
                        windowToKill.classList.add('hidden');
                        append(`Window '${args[0]}' killed.`);
                        // console.log(`Window '${args[0]}' killed.`); // Removed non-login/DB log
                    } else {
                        append(`Error: Window '${args[0]}' not found or already closed.`);
                        // console.warn(`kill: Window '${args[0]}' not found or already closed.`); // Removed non-login/DB log
                    }
                    break;
                case 'man':
                    if (!args[0]) { append("Usage: man [command]"); /* console.warn("man: Missing command name."); */ break; }
                    const manPage = {
                        'mkdir': 'mkdir [name] - Creates a new directory.',
                        'ls': 'ls - Lists contents of the current directory.',
                        'cd': 'cd [path] - Changes the current directory. Use ".." for parent, "/" for root.',
                        'cat': 'cat [file] - Displays the content of a text file.',
                        'touch': 'touch [file] - Creates an empty file.',
                        'rm': 'rm [file_or_dir] - Removes a file or an empty directory. Use "rm -r [dir]" for recursive deletion.',
                        'rmdir': 'rmdir [dir] - Removes an empty directory.',
                        'clear': 'clear - Clears the terminal screen.',
                        'ps': 'ps - Lists currently running windows (processes) and their IDs.',
                        'kill': 'kill [window_id] - Closes the specified window.',
                        'echo': 'echo [text] - Displays the provided text.',
                        'pwd': 'pwd - Prints the current working directory.',
                        'whoami': 'whoami - Displays the current logged-in username.',
                        'date': 'date - Displays the current date and time.',
                        'help': 'help - Displays a list of available commands.',
                        'restart': 'restart - Reloads the operating system concept.'
                    };
                    if (manPage[args[0].toLowerCase()]) {
                        append(manPage[args[0].toLowerCase()]);
                        // console.log(`man: Displayed manual for '${args[0]}'.`); // Removed non-login/DB log
                    } else {
                        append(`No manual entry for '${args[0]}'.`);
                        // console.warn(`man: No manual entry for '${args[0]}'.`); // Removed non-login/DB log
                    }
                    break;
                case 'echo':
                    append(args.join(' '));
                    // console.log(`echo: ${args.join(' ')}`); // Removed non-login/DB log
                    break;
                case 'pwd':
                    append(currentPath);
                    // console.log(`pwd: Current path is '${currentPath}'.`); // Removed non-login/DB log
                    break;
                case 'whoami':
                    append(activeUser || 'Guest');
                    // console.log(`whoami: Current user is '${activeUser || 'Guest'}'.`); // Removed non-login/DB log
                    break;
                case 'date':
                    append(new Date().toLocaleString());
                    // console.log(`date: Current date and time displayed.`); // Removed non-login/DB log
                    break;
                case 'history':
                    append("Command history not implemented yet.");
                    // console.warn("history: Not implemented."); // Removed non-login/DB log
                    break;
                case 'restart':
                    showConfirmBox("Restart System", "Are you sure you want to restart the system?", () => {
                        window.location.reload();
                        // console.log("System restart initiated."); // Removed non-login/DB log
                    });
                    break;
                default: append(`'${command}' is not recognized.`); /* console.warn(`Terminal: Unrecognized command '${command}'.`); */
            }
        };
        const createPrompt = () => {
            const promptContainer = document.createElement('div');
            promptContainer.className = 'flex';
            promptContainer.innerHTML = `<span class="text-green-400">${currentPath}>&nbsp;</span><input type="text" id="terminal-input" class="flex-grow bg-transparent border-none outline-none font-mono text-white">`;
            terminalOutput.appendChild(promptContainer);
            const input = document.getElementById('terminal-input');
            input.focus();
            input.addEventListener('keydown', (e) => { if(e.key === 'Enter') handleTerminalInput(e); });
            // console.log("Terminal prompt created."); // Removed non-login/DB log
        };
        const handleTerminalInput = (e) => {
            const input = e.target; const cmd = input.value;
            input.parentElement.remove();
            appendTerminalOutput(`<span class="text-green-400">${currentPath}>&nbsp;</span>${cmd}`);
            // console.log(`Terminal input received: '${cmd}'.`); // Removed non-login/DB log
            processCommand(cmd);
            createPrompt();
        };
        const appendTerminalOutput = (text) => { terminalOutput.innerHTML += `<div>${text.replace(/\n/g, '<br>')}</div>`; terminalOutput.scrollTop = terminalOutput.scrollHeight; };
        // --- Window Management (Drag & Resize) ---
        let activeWindow = null, action = null, startX, startY, startW, startH;
        const startAction = (e, windowEl, currentAction) => {
            action = currentAction;
            activeWindow = windowEl;
            // Bring the active window to the front by setting a higher z-index
            document.querySelectorAll('.window').forEach(w => w.style.zIndex = '40'); // Reset others
            activeWindow.style.zIndex = '45'; // Bring active to front
            // console.log(`Window '${windowEl.id}' activated for ${currentAction}.`); // Removed non-login/DB log

            const event = e.type === 'touchstart' ? e.touches[0] : e;
            startX = event.clientX; startY = event.clientY;
            // Store initial position for dragging, initial dimensions for resizing
            activeWindow.dataset.initialLeft = activeWindow.offsetLeft;
            activeWindow.dataset.initialTop = activeWindow.offsetTop;
            startW = parseInt(document.defaultView.getComputedStyle(activeWindow).width, 10);
            startH = parseInt(document.defaultView.getComputedStyle(activeWindow).height, 10);
            document.addEventListener('mousemove', doAction); document.addEventListener('mouseup', endAction);
            document.addEventListener('touchmove', doAction, { passive: false });
            document.addEventListener('touchend', endAction);
        };
        const doAction = (e) => {
            if (!activeWindow) return;
            e.preventDefault();
            const event = e.type === 'touchmove' ? e.touches[0] : e;
            const dx = event.clientX - startX;
            const dy = event.clientY - startY;

            if (action === 'drag') {
                const initialLeft = parseInt(activeWindow.dataset.initialLeft, 10);
                const initialTop = parseInt(activeWindow.dataset.initialTop, 10);
                activeWindow.style.left = `${initialLeft + dx}px`;
                activeWindow.style.top = `${initialTop + dy}px`;
            } else if (action === 'resize') {
                activeWindow.style.width = `${startW + dx}px`;
                activeWindow.style.height = `${startH + dy}px`;
            }
        };
        const endAction = () => {
            if (activeWindow) {
                // console.log(`Window '${activeWindow.id}' ${action} action ended.`); // Removed non-login/DB log
            }
            activeWindow = null;
            action = null;
            document.removeEventListener('mousemove', doAction);
            document.removeEventListener('mouseup', endAction);
            document.removeEventListener('touchmove', doAction);
            document.removeEventListener('touchend', endAction);
        };
        document.querySelectorAll('.window').forEach(win => {
            const titleBar = win.querySelector('.title-bar');
            const resizeHandle = win.querySelector('.resize-handle');
            if (titleBar) {
                titleBar.addEventListener('mousedown', e => startAction(e, win, 'drag'));
                titleBar.addEventListener('touchstart', e => startAction(e, win, 'drag'));
            }
            if (resizeHandle) {
                resizeHandle.addEventListener('mousedown', e => startAction(e, win, 'resize'));
                resizeHandle.addEventListener('touchstart', e => startAction(e, win, 'resize'));
            }
        });
        // --- Init & Other Listeners ---
        const openWindow = (windowId, initialContentId = null) => {
            const windowEl = document.getElementById(windowId);
            if(windowEl) {
                windowEl.classList.remove('hidden');
                // console.log(`Window '${windowId}' opened.`); // Removed non-login/DB log
            }
            if(windowId === 'terminal-window' && !terminalOutput.hasChildNodes()) createPrompt();
            if(windowId === 'file-explorer-window') renderFileExplorer();
            if(windowId === 'settings-window' && initialContentId) {
                settingsTabs.forEach(tab => tab.classList.remove('bg-white/20', 'dark:bg-black/20'));
                settingsContents.forEach(content => content.classList.add('hidden'));
                const targetTab = document.querySelector(`.settings-tab[data-content-id="${initialContentId}"]`);
                const targetContent = document.getElementById(initialContentId);
                if(targetTab) targetTab.classList.add('bg-white/20', 'dark:bg-black/20');
                if(targetContent) targetContent.classList.remove('hidden');
                // console.log(`Settings window opened to tab: '${initialContentId}'.`); // Removed non-login/DB log
            } else if (windowId === 'updates-window') {
                updatesTabs.forEach(tab => tab.classList.remove('bg-white/20', 'dark:bg-black/20'));
                updatesContents.forEach(content => content.classList.add('hidden'));
                const defaultUpdatesTab = document.querySelector('.updates-tab[data-content-id="updates-list-content"]');
                const defaultUpdatesContent = document.getElementById('updates-list-content');
                if (defaultUpdatesTab) defaultUpdatesTab.classList.add('bg-white/20', 'dark:bg-black/20');
                if (defaultUpdatesContent) defaultUpdatesContent.classList.remove('hidden');
                // console.log("Updates window opened."); // Removed non-login/DB log
            }
            if (windowId === 'start-menu') {
                renderQuickAccess();
                // console.log("Start Menu opened."); // Removed non-login/DB log
            }
            document.querySelectorAll('.window').forEach(w => w.style.zIndex = '40');
            if(windowEl) windowEl.style.zIndex = '45';
        };
        document.querySelectorAll('[data-window]').forEach(btn => btn.addEventListener('click', e => { 
            e.stopPropagation(); 
            openWindow(btn.getAttribute('data-window')); 
        }));
        document.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', e => { 
            e.stopPropagation(); 
            const windowId = btn.getAttribute('data-window');
            document.getElementById(windowId).classList.add('hidden'); 
            // console.log(`Window '${windowId}' closed.`); // Removed non-login/DB log
        }));

        // --- CPU and Memory Simulation ---

        class Memory {
            constructor(size) {
                this.buffer = new ArrayBuffer(size * Float64Array.BYTES_PER_ELEMENT);
                this.data = new Float64Array(this.buffer);
                this.size = size;
                this.allocatedPointer = 0;
                // console.log(`Memory initialized with size ${size}.`); // Removed non-login/DB log
            }

            read(address) {
                if (address < 0 || address >= this.size) {
                    // console.error(`Memory access violation: Address ${address} out of bounds.`); // Removed non-login/DB log
                    return NaN;
                }
                const value = this.data[address];
                // console.log(`Memory: Read ${value} from address ${address}.`); // Removed non-login/DB log
                return value;
            }

            write(address, value) {
                if (address < 0 || address >= this.size) {
                    // console.error(`Memory access violation: Address ${address} out of bounds.`); // Removed non-login/DB log
                    return;
                }
                this.data[address] = value;
                // console.log(`Memory: Written ${value} to address ${address}.`); // Removed non-login/DB log
            }

            allocate(size = 1) {
                if (this.allocatedPointer + size > this.size) {
                    // console.error("Memory allocation failed: Not enough space."); // Removed non-login/DB log
                    return -1;
                }
                const address = this.allocatedPointer;
                for(let i = 0; i < size; i++) {
                    this.data[address + i] = 0;
                }
                this.allocatedPointer += size;
                // console.log(`Memory: Allocated ${size} units starting at address ${address}.`); // Removed non-login/DB log
                return address;
            }

            reset() {
                this.data.fill(0);
                this.allocatedPointer = 0;
                // console.log("Memory reset."); // Removed non-login/DB log
            }
        }

        class CPU {
            constructor(memory) {
                this.memory = memory;
                this.registers = {
                    PC: 0,
                    ACC: 0,
                    R1: 0,
                    R2: 0
                };
                this.isRunning = false;
                this.program = [];
                this.programStartAddr = 0;
                this.speed = 100;
                // console.log("CPU initialized."); // Removed non-login/DB log
            }

            static Instructions = {
                LOAD: 0x01, STORE: 0x02, ADD: 0x03, SUB: 0x04, JUMP: 0x05, JUMPIFZERO: 0x06, SET: 0x07, HALT: 0xFF
            };

            reset() {
                this.registers.PC = 0;
                this.registers.ACC = 0;
                this.registers.R1 = 0;
                this.registers.R2 = 0;
                this.program = [];
                this.programStartAddr = 0;
                this.isRunning = false;
                this.memory.reset();
                // console.log("CPU registers and program state reset."); // Removed non-login/DB log
            }

            loadProgram(program) {
                this.reset();
                this.program = program;
                let currentAddress = this.memory.allocate(program.length);
                if (currentAddress === -1) {
                    // console.error("Failed to allocate space for program."); // Removed non-login/DB log
                    showMessageBox("Error", "Failed to allocate memory for program. Memory full?");
                    return;
                }
                for (let i = 0; i < program.length; i++) {
                    this.memory.write(currentAddress + i, program[i]);
                }
                this.programStartAddr = currentAddress;
                this.registers.PC = currentAddress;
                // console.log(`Program loaded starting at address ${this.registers.PC}. Program length: ${program.length}`); // Removed non-login/DB log
            }

            step() {
                if (this.registers.PC < 0 || this.registers.PC >= this.memory.size) {
                    // console.log("CPU: Program Counter out of memory bounds. Halting."); // Removed non-login/DB log
                    this.isRunning = false;
                    return;
                }
                if (this.program.length > 0 && 
                    (this.registers.PC < this.programStartAddr || this.registers.PC >= this.programStartAddr + this.program.length)) {
                    // console.log("CPU: Program Counter outside loaded program's execution bounds. Halting."); // Removed non-login/DB log
                    this.isRunning = false;
                    return;
                }

                const instruction = this.memory.read(this.registers.PC);
                this.registers.PC++;

                switch (instruction) {
                    case CPU.Instructions.LOAD:
                        const loadAddress = this.memory.read(this.registers.PC++);
                        this.registers.ACC = this.memory.read(loadAddress);
                        // console.log(`CPU: LOAD ${loadAddress} (ACC = ${this.registers.ACC})`); // Removed non-login/DB log
                        break;
                    case CPU.Instructions.STORE:
                        const storeAddress = this.memory.read(this.registers.PC++);
                        this.memory.write(storeAddress, this.registers.ACC);
                        // console.log(`CPU: STORE ${storeAddress} (Value = ${this.registers.ACC})`); // Removed non-login/DB log
                        break;
                    case CPU.Instructions.ADD:
                        const addAddress = this.memory.read(this.registers.PC++);
                        this.registers.ACC += this.memory.read(addAddress);
                        // console.log(`CPU: ADD ${addAddress} (ACC = ${this.registers.ACC})`); // Removed non-login/DB log
                        break;
                    case CPU.Instructions.SUB:
                        const subAddress = this.memory.read(this.registers.PC++);
                        this.registers.ACC -= this.memory.read(subAddress);
                        // console.log(`CPU: SUB ${subAddress} (ACC = ${this.registers.ACC})`); // Removed non-login/DB log
                        break;
                    case CPU.Instructions.JUMP:
                        const jumpAddress = this.memory.read(this.registers.PC++);
                        this.registers.PC = jumpAddress;
                        // console.log(`CPU: JUMP to ${jumpAddress}`); // Removed non-login/DB log
                        break;
                    case CPU.Instructions.JUMPIFZERO:
                        const jumpIfZeroAddress = this.memory.read(this.registers.PC++);
                        if (this.registers.ACC === 0) {
                            this.registers.PC = jumpIfZeroAddress;
                            // console.log(`CPU: JUMPIFZERO (ACC is 0) to ${jumpIfZeroAddress}`); // Removed non-login/DB log
                        } else {
                            // console.log(`CPU: JUMPIFZERO (ACC is not 0), skipped jump`); // Removed non-login/DB log
                        }
                        break;
                    case CPU.Instructions.SET:
                        const registerCode = this.memory.read(this.registers.PC++);
                        const value = this.memory.read(this.registers.PC++);
                        if (registerCode === 0) this.registers.ACC = value;
                        else if (registerCode === 1) this.registers.R1 = value;
                        else if (registerCode === 2) this.registers.R2 = value;
                        // console.log(`CPU: SET Reg:${registerCode} Value:${value}`); // Removed non-login/DB log
                        break;
                    case CPU.Instructions.HALT:
                        // console.log("CPU: HALT instruction encountered. Stopping execution."); // Removed non-login/DB log
                        this.isRunning = false;
                        break;
                    default:
                        // console.error(`CPU: Unknown instruction: ${instruction} at PC: ${this.registers.PC - 1}. Halting.`); // Removed non-login/DB log
                        this.isRunning = false;
                        break;
                }
                updateCPUMonitorUI();
            }

            async execute() {
                this.isRunning = true;
                // console.log("CPU: Starting program execution."); // Removed non-login/DB log
                while (this.isRunning) {
                    this.step();
                    if (!this.isRunning) {
                        break;
                    }
                    await new Promise(resolve => setTimeout(resolve, this.speed));
                }
                // console.log("CPU: Execution finished."); // Removed non-login/DB log
                showMessageBox("Program Finished", "CPU program execution has completed.");
            }
        }

        // Initialize Memory and CPU
        const memory = new Memory(256);
        const cpu = new CPU(memory);

        // --- UI Update Functions for CPU Monitor ---
        const updateCPURegistersUI = () => {
            cpuRegistersDisplay.innerHTML = '';
            for (const reg in cpu.registers) {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-700/50 p-2 rounded-md';
                div.innerHTML = `<span class="font-semibold text-white">${reg}:</span><span class="font-mono text-right text-green-300">${cpu.registers[reg]}</span>`;
                cpuRegistersDisplay.appendChild(div);
            }
            // console.log("CPU registers UI updated."); // Removed non-login/DB log
        };

        const updateMemoryDisplayUI = () => {
            memoryDisplay.innerHTML = '';
            const cellsPerRow = 8;
            for (let i = 0; i < memory.size; i += cellsPerRow) {
                const row = document.createElement('div');
                row.className = 'flex w-full mb-1';
                
                const addressLabel = document.createElement('span');
                addressLabel.className = 'w-1/8 text-gray-400 mr-2 min-w-[50px] text-right';
                addressLabel.textContent = `0x${i.toString(16).padStart(3, '0')}:`;
                row.appendChild(addressLabel);

                for (let j = 0; j < cellsPerRow; j++) {
                    const address = i + j;
                    const cell = document.createElement('span');
                    const isProgramInstruction = (address >= cpu.programStartAddr && address < cpu.programStartAddr + cpu.program.length);
                    const isCurrentPC = cpu.registers.PC === address && cpu.isRunning;

                    cell.className = `flex-1 p-1 rounded-sm text-center 
                                      ${isCurrentPC ? 'bg-purple-600 text-white font-bold' : 
                                       (isProgramInstruction ? 'bg-indigo-700/50 text-blue-200' : 'bg-gray-700/50')}`;
                    const value = memory.read(address);
                    cell.textContent = isNaN(value) ? '--' : value.toFixed(0);
                    row.appendChild(cell);
                }
                memoryDisplay.appendChild(row);
            }
            // console.log("Memory display UI updated."); // Removed non-login/DB log
        };


        const updateCPUMonitorUI = () => {
            updateCPURegistersUI();
            updateMemoryDisplayUI();
            // console.log("CPU Monitor UI fully updated."); // Removed non-login/DB log
        };

        // --- CPU Monitor Event Listeners ---
        loadProgramBtn.addEventListener('click', () => {
            try {
                const programText = programEditor.value.trim();
                const programLines = programText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                
                const parsedProgram = [];
                programLines.forEach(line => {
                    const parts = line.split(';');
                    const instructionPart = parts[0].trim();
                    if (instructionPart === '') return;

                    const instructionWords = instructionPart.split(/\s+/);
                    const instructionName = instructionWords[0].toUpperCase();
                    
                    if (CPU.Instructions[instructionName] !== undefined) {
                        parsedProgram.push(CPU.Instructions[instructionName]);
                        for (let i = 1; i < instructionWords.length; i++) {
                            const arg = parseInt(instructionWords[i], 10);
                            if (!isNaN(arg)) {
                                parsedProgram.push(arg);
                            } else {
                                // console.warn(`Skipping non-numeric argument: ${instructionWords[i]} in line: "${line}"`); // Removed non-login/DB log
                            }
                        }
                    } else if (!isNaN(parseInt(instructionPart, 10))) {
                        parsedProgram.push(parseInt(instructionPart, 10));
                    } else {
                        // console.warn(`Unknown instruction or invalid data: "${instructionPart}" in line: "${line}"`); // Removed non-login/DB log
                        showMessageBox("Program Load Warning", `Unknown instruction or invalid data: "${instructionPart}". Check console for details.`);
                    }
                });

                cpu.loadProgram(parsedProgram);
                updateCPUMonitorUI();
                showMessageBox("Program Loaded", "Program loaded successfully! PC set to start.");
                // console.log("Program loaded successfully from editor."); // Removed non-login/DB log
            } catch (error) {
                // console.error("Error loading program:", error); // Removed non-login/DB log
                showMessageBox("Error", "Failed to load program. Check console for details.");
            }
        });

        runProgramBtn.addEventListener('click', () => {
            if (!cpu.isRunning) {
                cpu.execute();
                // console.log("Run program button clicked: CPU execution started."); // Removed non-login/DB log
            } else {
                showMessageBox("CPU Busy", "CPU is already running. Please wait for it to finish or reset.");
                // console.warn("Run program button clicked: CPU already running."); // Removed non-login/DB log
            }
        });

        stepProgramBtn.addEventListener('click', () => {
            if (!cpu.isRunning) {
                cpu.step();
                // console.log("Step program button clicked: Executed one CPU step."); // Removed non-login/DB log
            } else {
                showMessageBox("CPU Busy", "CPU is already running. Stop it before stepping.");
                // console.warn("Step program button clicked: CPU already running."); // Removed non-login/DB log
            }
        });

        resetCpuBtn.addEventListener('click', () => {
            cpu.reset();
            updateCPUMonitorUI();
            showMessageBox("CPU Reset", "CPU and Memory have been reset.");
            // console.log("Reset CPU/Mem button clicked: CPU and memory reset."); // Removed non-login/DB log
        });

        const cpuMonitorWindow = document.getElementById('cpu-monitor-window');
        if (cpuMonitorWindow) {
            const observer = new MutationObserver((mutationsList) => {
                for (const mutation of mutationsList) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        if (!cpuMonitorWindow.classList.contains('hidden')) {
                            updateCPUMonitorUI();
                            // console.log("CPU Monitor window became visible, UI updated."); // Removed non-login/DB log
                        }
                    }
                }
            });
            observer.observe(cpuMonitorWindow, { attributes: true });
        }

        programEditor.value = `SET 0 10   ; Set ACC to 10
STORE 20   ; Store ACC (10) at memory address 20
SET 0 5    ; Set ACC to 5
STORE 21   ; Store ACC (5) at memory address 21
LOAD 20    ; Load value from address 20 (10) into ACC
ADD 21     ; Add value from address 21 (5) to ACC (ACC becomes 15)
STORE 22   ; Store ACC (15) at memory address 22
HALT       ; End program
`;

        updateCPUMonitorUI();

        // --- Desktop Clock ---
        const updateClock = () => {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            clockElement.textContent = `${hours}:${minutes}:${seconds}`;
        };
        setInterval(updateClock, 1000);
        updateClock();

        clockContainer.addEventListener('click', () => {
            openWindow('settings-window', 'about-content');
            // console.log("Clock clicked: Opened settings to About tab."); // Removed non-login/DB log
        });


        // --- Desktop Context Menu ---
        desktop.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            desktopContextMenu.style.left = `${e.clientX}px`;
            desktopContextMenu.style.top = `${e.clientY}px`;
            desktopContextMenu.classList.remove('hidden');
            // console.log("Desktop context menu opened."); // Removed non-login/DB log
        });

        document.addEventListener('click', (e) => {
            if (!desktopContextMenu.contains(e.target)) {
                desktopContextMenu.classList.add('hidden');
                // console.log("Desktop context menu hidden."); // Removed non-login/DB log
            }
            if (!fileExplorerContextMenu.contains(e.target)) {
                fileExplorerContextMenu.classList.add('hidden');
                // console.log("File Explorer context menu hidden."); // Removed non-login/DB log
            }
        });

        openSettingsContextBtn.addEventListener('click', (e) => {
            e.preventDefault();
            openWindow('settings-window', 'background-content');
            desktopContextMenu.classList.add('hidden');
            // console.log("Context menu: Opened settings to Background tab."); // Removed non-login/DB log
        });

        // --- Settings Window Logic ---
        settingsTabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                settingsTabs.forEach(t => t.classList.remove('bg-white/20', 'dark:bg-black/20'));
                settingsContents.forEach(c => c.classList.add('hidden'));

                tab.classList.add('bg-white/20', 'dark:bg-black/20');
                const targetContentId = tab.getAttribute('data-content-id');
                const targetContent = document.getElementById(targetContentId);
                if(targetContent) targetContent.classList.remove('hidden');
                // console.log(`Settings tab '${targetContentId}' activated.`); // Removed non-login/DB log
            });
        });

        setLightBgBtn.addEventListener('click', () => {
            applyTheme('light');
            // console.log("Theme set to Light."); // Removed non-login/DB log
        });
        setDarkBgBtn.addEventListener('click', () => {
            applyTheme('dark');
            // console.log("Theme set to Dark."); // Removed non-login/DB log
        });

        bgColorPicker.addEventListener('input', (e) => {
            desktop.style.backgroundImage = 'none';
            desktop.style.backgroundColor = e.target.value;
            localStorage.setItem('customBgColor', e.target.value);
            localStorage.removeItem('theme');
            // console.log(`Custom background color set to: ${e.target.value}.`); // Removed non-login/DB log
        });

        const applyTheme = (theme) => {
            desktop.style.backgroundColor = '';
            localStorage.removeItem('customBgColor');
            if (theme === 'dark') {
                document.body.classList.add('dark');
                desktop.classList.remove('desktop-light');
                desktop.classList.add('desktop-dark');
            } else {
                document.body.classList.remove('dark');
                desktop.classList.remove('desktop-dark');
                desktop.classList.add('desktop-light');
            }
            localStorage.setItem('theme', theme);
            // console.log(`Applied theme: ${theme}.`); // Removed non-login/DB log
        };

        const savedTheme = localStorage.getItem('theme') || 'dark';
        const savedCustomColor = localStorage.getItem('customBgColor');

        if (savedCustomColor) {
            desktop.style.backgroundImage = 'none';
            desktop.style.backgroundColor = savedCustomColor;
            bgColorPicker.value = savedCustomColor;
            document.body.classList.remove('dark');
            // console.log(`Loaded custom background color: ${savedCustomColor}.`); // Removed non-login/DB log
        } else {
            applyTheme(savedTheme);
            // console.log(`Loaded theme: ${savedTheme}.`); // Removed non-login/DB log
        }

        // --- Quick Access Functions ---
        const MAX_RECENT_FILES = 5;

        const addRecentFile = (filePath, fileName) => {
            const existingIndex = recentFiles.findIndex(file => file.path === filePath);

            if (existingIndex !== -1) {
                recentFiles.splice(existingIndex, 1);
            }

            recentFiles.unshift({ path: filePath, name: fileName });

            if (recentFiles.length > MAX_RECENT_FILES) {
                recentFiles = recentFiles.slice(0, MAX_RECENT_FILES);
            }

            localStorage.setItem('recentFiles', JSON.stringify(recentFiles));
            renderQuickAccess();
            // console.log(`Added '${fileName}' to recent files. Current recent files:`, recentFiles); // Removed non-login/DB log
        };

        const renderQuickAccess = () => {
            quickAccessContent.innerHTML = '';

            if (recentFiles.length === 0) {
                quickAccessContent.innerHTML = '<p class="text-sm text-gray-400">No recent files.</p>';
                // console.log("No recent files to display in Quick Access."); // Removed non-login/DB log
                return;
            }

            recentFiles.forEach(file => {
                const fileElement = document.createElement('a');
                fileElement.href = "#";
                fileElement.className = "flex items-center space-x-2 p-2 rounded-md hover:bg-white/30 dark:hover:bg-black/30 transition-colors";
                
                let materialIcon = '';
                let iconColor = '';
                if (file.name.endsWith('.txt')) {
                    materialIcon = 'description';
                    iconColor = 'text-gray-300';
                } else if (file.name.endsWith('.py')) {
                    materialIcon = 'code';
                    iconColor = 'text-blue-400';
                } else {
                    materialIcon = 'insert_drive_file';
                    iconColor = 'text-gray-500';
                }

                fileElement.innerHTML = `<span class="material-symbols-outlined ${iconColor}">${materialIcon}</span><span>${file.name}</span>`;
                
                fileElement.addEventListener('click', (e) => {
                    e.preventDefault();
                    openFileInTextEditor(file.path, file.name);
                    startMenu.classList.add('hidden');
                });
                quickAccessContent.appendChild(fileElement);
            });
            // console.log("Quick Access UI rendered."); // Removed non-login/DB log
        };

        startMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            startMenu.classList.toggle('hidden');
            if (!startMenu.classList.contains('hidden')) {
                renderQuickAccess();
                startMenuUsername.textContent = activeUser || 'Guest';
                // console.log("Start Menu toggled to visible."); // Removed non-login/DB log
            } else {
                // console.log("Start Menu toggled to hidden."); // Removed non-login/DB log
            }
        });

        document.addEventListener('click', (e) => {
            if (!startMenu.contains(e.target) && !startMenuBtn.contains(e.target) && !powerOptionsMenu.contains(e.target)) {
                if (!startMenu.classList.contains('hidden')) {
                    startMenu.classList.add('hidden');
                    powerOptionsMenu.classList.add('hidden');
                    // console.log("Start Menu and Power Options hidden due to outside click."); // Removed non-login/DB log
                }
            }
        });

        powerOptionsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            powerOptionsMenu.classList.toggle('hidden');
            // console.log("Power options menu toggled."); // Removed non-login/DB log
        });

        signOutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            showConfirmBox("Sign Out", "Are you sure you want to sign out? This will clear your password for this session and return you to the login screen.", () => {
                if (activeUser) {
                    let users = loadUsers();
                    if (users[activeUser]) {
                        users[activeUser].hashedPassword = "";
                        saveUsers(users);
                        console.log(`[LOGIN/DB] Password for '${activeUser}' cleared upon sign out.`); // Log password cleared
                    }
                    localStorage.removeItem('win13_active_user');
                    console.log(`[LOGIN] User '${activeUser}' signed out.`); // Log user sign out
                }
                window.location.reload();
            });
        });

        restartBtn.addEventListener('click', (e) => {
            e.preventDefault();
            showConfirmBox("Restart System", "Are you sure you want to restart the system?", () => {
                window.location.reload();
                // console.log("System restart confirmed and initiated."); // Removed non-login/DB log
            });
        });

        renderQuickAccess();

        const toggleScrollbars = () => {
            const prefersNoScrollbars = document.body.classList.toggle('hide-scrollbars');
            localStorage.setItem('hideScrollbars', prefersNoScrollbars);
            // console.log(`Scrollbars visibility toggled to: ${!prefersNoScrollbars}.`); // Removed non-login/DB log
        };

        toggleScrollbarsBtn.addEventListener('click', toggleScrollbars);

        if (localStorage.getItem('hideScrollbars') === 'true') {
            document.body.classList.add('hide-scrollbars');
            // console.log("Scrollbars hidden on load based on preference."); // Removed non-login/DB log
        } else {
            // console.log("Scrollbars visible on load based on preference."); // Removed non-login/DB log
        }
    });
    </script>
</body>
</html>
