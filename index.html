<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows 13 Concept</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fira Code Font -->
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        body { font-family: 'Inter', sans-serif; user-select: none; color: #e0e0e0; background-color: #1a1a2e; overflow: hidden; }
        body.light { color: #1a1a2e; background-color: #e0e0e0; } /* Light mode body colors */
        .font-mono { font-family: 'monospace'; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24; }
        
        #desktop-container {
            background-image: url('Assets/Background/dark.png');
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            background-size: cover;
            background-position: center;
        }

        body.light #desktop-container {
            background-image: url('Assets/Background/light.png'); /* Light mode background */
        }

        #login-container {
            /* Ensure the login container covers the whole screen */
            background-color: transparent; /* Make it transparent to see the blurred background */
        }

        #login-background-blur {
            position: absolute;
            inset: 0;
            background-image: url('Assets/Background/dark.png'); /* Same background as desktop */
            background-size: cover;
            background-position: center;
            filter: blur(10px); /* Apply blur effect */
            transition: filter 0.5s ease-in-out;
            z-index: -1; /* Ensure it stays behind login content */
        }

        body.light #login-background-blur {
            background-image: url('Assets/Background/light.png'); /* Light mode background */
        }

        .panel {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.light .panel {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #1a1a2e;
        }

        body.light .panel input {
            background-color: rgba(255, 255, 255, 0.8);
            border-color: rgba(0, 0, 0, 0.3);
            color: #1a1a2e;
        }
        body.light .panel input::placeholder {
            color: rgba(0, 0, 0, 0.6);
        }
        body.light .panel button {
            background-color: #6d28d9;
            color: white;
        }
        body.light .panel button:hover {
            background-color: #5b21aa;
        }
        body.light .panel p {
            color: #333;
        }
        body.light .panel a {
            color: #5b21aa;
        }

        body.light .bg-gray-800\/50 {
            background-color: rgba(200, 200, 200, 0.5); /* Lighter background for light mode window content */
        }
        body.light .bg-black\/80 {
            background-color: rgba(255, 255, 255, 0.8); /* Lighter background for terminal */
            color: #1a1a2e; /* Darker text for terminal */
        }
        body.light .text-green-400 {
            color: #1e88e5; /* Different color for terminal prompt in light mode */
        }

        body.light .top-app-icon {
            background-color: rgba(255, 255, 255, 0.3);
        }
        body.light .top-app-icon:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes open-animation { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .animate-open { animation: open-animation 0.2s ease-out; }

        .window { transition: opacity 0.2s, transform 0.2s, top 0.2s, left 0.2s, width 0.2s, height 0.2s; min-width: 300px; min-height: 200px; }
        .title-bar { cursor: move; }
        
        .resize-handle { position: absolute; bottom: 0; right: 0; width: 16px; height: 16px; cursor: se-resize; }
        .calculator-btn {
            @apply bg-gray-700/50 hover:bg-gray-600/50 rounded-lg text-2xl font-semibold transition-colors flex items-center justify-center;
        }
        body.light .calculator-btn {
            background-color: rgba(150, 150, 150, 0.5);
            color: #1a1a2e;
        }
        body.light .calculator-btn:hover {
            background-color: rgba(120, 120, 150, 0.5);
        }
        body.light .calculator-btn.operator {
             background-color: #7c3aed;
             color: white;
        }
        body.light .calculator-btn.operator:hover {
             background-color: #6d28d9;
        }
        body.light #calc-display {
            background-color: rgba(255, 255, 255, 0.9);
            color: #1a1a2e;
        }

        /* Code Editor Specific Styles */
        .code-editor-container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            background-color: #1e1e1e; /* Dark background for code editor */
            color: #d4d4d4; /* Light text for code */
            font-family: 'Fira Code', monospace; /* Fira Code font */
            font-size: 0.875rem; /* text-sm */
            line-height: 1.5; /* Ensure consistent line height */
        }
        body.light .code-editor-container {
            background-color: #f3f3f3;
            color: #333;
        }

        #code-editor-sidebar {
            width: 180px; /* Fixed width for sidebar */
            background-color: #252526; /* Darker background for sidebar */
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            flex-shrink: 0;
            padding: 8px;
        }
        body.light #code-editor-sidebar {
            background-color: #e6e6e6;
            border-right: 1px solid rgba(0, 0, 0, 0.1);
        }

        .editor-file-item {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 2px;
            transition: background-color 0.1s ease;
        }
        .editor-file-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        body.light .editor-file-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        .editor-file-item.active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        body.light .editor-file-item.active {
            background-color: rgba(0, 0, 0, 0.1);
        }


        .code-editor-main-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #code-editor-tab-bar {
            display: flex;
            flex-wrap: wrap;
            background-color: #2d2d2d; /* Tabs background */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-left: 5px;
            flex-shrink: 0; /* Prevent shrinking */
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap; /* Keep tabs in a single line */
            -ms-overflow-style: none; /* Hide scrollbar for IE/Edge */
            scrollbar-width: none; /* Hide scrollbar for Firefox */
        }
        #code-editor-tab-bar::-webkit-scrollbar {
            display: none; /* Hide scrollbar for Chrome, Safari, Opera */
        }
        body.light #code-editor-tab-bar {
            background-color: #e0e0e0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .editor-tab {
            padding: 8px 12px;
            cursor: pointer;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            background-color: #2d2d2d;
            border-bottom: 3px solid transparent;
            transition: background-color 0.1s, border-color 0.1s;
            position: relative;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        body.light .editor-tab {
            background-color: #e0e0e0;
            border-right: 1px solid rgba(0, 0, 0, 0.05);
        }

        .editor-tab:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        body.light .editor-tab:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }

        .editor-tab.active {
            background-color: #1e1e1e; /* Active tab background */
            border-bottom-color: #007acc; /* VSCode blue indicator */
        }
        body.light .editor-tab.active {
            background-color: #f3f3f3;
            border-bottom-color: #007acc;
        }

        .tab-close-btn {
            font-size: 1rem;
            margin-left: 8px;
            cursor: pointer;
            color: #858585;
            transition: color 0.1s;
        }
        .tab-close-btn:hover {
            color: #d4d4d4;
        }
        body.light .tab-close-btn {
            color: #555;
        }
        body.light .tab-close-btn:hover {
            color: #333;
        }


        .code-editor-content {
            display: flex;
            flex-grow: 1;
            overflow: hidden; /* Important for scroll sync */
        }

        .line-numbers {
            width: 40px; /* Fixed width for line numbers */
            padding: 8px 4px;
            text-align: right;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            background-color: #252526; /* Slightly lighter than code background */
            color: #858585; /* Grayed out line numbers */
            flex-shrink: 0; /* Prevent shrinking */
            line-height: 1.5; /* Match line height with textarea */
            overflow-y: hidden; /* Keep this to hide scrollbar if textarea has one */
        }
        body.light .line-numbers {
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            background-color: #f0f0f0;
            color: #555;
        }

        .code-area-wrapper {
            position: relative;
            flex-grow: 1;
            overflow: hidden;
        }

        #code-editor-textarea, #code-highlighting {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 8px;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.5; /* Match line height with line numbers */
            font-family: 'Fira Code', monospace; /* Fira Code font */
            white-space: pre; /* Preserve whitespace for better code display */
            box-sizing: border-box; /* Include padding in width/height */
        }

        #code-editor-textarea {
            resize: none;
            outline: none;
            border: none;
            background-color: transparent; /* Make it transparent */
            color: transparent; /* Make text transparent */
            caret-color: #d4d4d4; /* Keep cursor visible */
            z-index: 1; /* Place textarea above highlighting */
            overflow-y: scroll; /* Allow textarea to scroll */
        }
        body.light #code-editor-textarea {
             caret-color: #333;
        }


        #code-highlighting {
            z-index: 0; /* Place highlighting behind textarea */
            pointer-events: none; /* Allow mouse events to pass through to textarea */
            overflow-y: scroll; /* Synchronize scroll with textarea */
        }
        
        /* Syntax highlighting colors */
        .syntax-keyword { color: #569cd6; } /* Blue */
        .syntax-string { color: #ce9178; } /* Orange/Brown */
        .syntax-comment { color: #6a9955; } /* Green */
        .syntax-number { color: #b5cea8; } /* Light green */
        .syntax-function { color: #dcdcaa; } /* Yellow */
        .syntax-operator { color: #d4d4d4; } /* White/Light gray */
        .syntax-variable { color: #9cdcfe; } /* Light blue */

        /* Light mode syntax highlighting colors */
        body.light .syntax-keyword { color: #0000ff; } /* Darker blue */
        body.light .syntax-string { color: #a31515; } /* Darker red */
        body.light .syntax-comment { color: #008000; } /* Darker green */
        body.light .syntax-number { color: #098677; } /* Teal */
        body.light .syntax-function { color: #795e26; } /* Darker yellow */
        body.light .syntax-operator { color: #333333; } /* Darker gray */
        body.light .syntax-variable { color: #001080; } /* Darker blue */


        #code-editor-bottom-panel {
            flex-shrink: 0; /* Prevent shrinking */
            height: 100px; /* Fixed height for bottom panel */
            background-color: #2d2d2d; /* Similar to tab bar */
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            padding: 8px;
            font-size: 0.8rem;
            color: #cccccc;
            white-space: pre-wrap; /* Preserve formatting for output */
        }
        body.light #code-editor-bottom-panel {
            background-color: #e0e0e0;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            color: #333;
        }
        /* Boot and Install Screen Styles - HIDDEN/REMOVED */

        /* Custom Modal Styles (reused for alert and prompt) */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .custom-modal-content {
            background-color: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
            color: white;
        }

        .custom-modal-content button {
            margin-top: 10px;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #custom-alert-ok-btn, #custom-prompt-ok-btn {
            background-color: #6d28d9; /* Purple */
            color: white;
        }
        #custom-alert-ok-btn:hover, #custom-prompt-ok-btn:hover {
            background-color: #5b21aa;
        }
        #custom-prompt-cancel-btn {
            background-color: #4a5568; /* Gray */
            color: white;
        }
        #custom-prompt-cancel-btn:hover {
            background-color: #2d3748;
        }
        /* Add light mode styles for the modal content */
        body.light .custom-modal-content {
            background-color: #f3f3f3;
            color: #1a1a2e;
        }
        body.light .custom-modal-content button {
            color: white; /* Buttons in light mode remain white text for contrast */
        }
        body.light #custom-prompt-input {
            background-color: rgba(255, 255, 255, 0.9);
            border-color: rgba(0, 0, 0, 0.2);
            color: #1a1a2e;
        }
        body.light #custom-prompt-input::placeholder {
            color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="overflow-hidden">
  <!-- Windows 14 is in Alfa Uniform Golf Foxtrot Oscar Romeo Tango Echo Echo November Delta Alfa Yankee -->
    <audio id="boot-sound" src="bootup/boot.mp3" preload="auto"></audio>
    <div id="power-off-screen" class="hidden absolute inset-0 z-[100] flex flex-col items-center justify-center bg-black transition-opacity duration-500"><h2 id="power-off-message" class="text-2xl font-bold text-white mb-6"></h2></div>

    <!-- Boot Screen - Removed -->
    <!-- Install Screen - Removed -->

    <!-- Login/Register Screen -->
    <div id="login-container" class="absolute inset-0 z-50 flex flex-col items-center justify-center transition-opacity duration-500">
        <div id="login-background-blur"></div>
        <div id="login-view" class="relative z-10 flex flex-col items-center justify-center p-8 rounded-lg panel">
            <img src="https://placehold.co/128x128/7c3aed/ffffff?text=U" alt="User Avatar" class="rounded-full w-32 h-32 border-4 border-purple-500 mb-4 mx-auto">
            <h2 id="current-username-display" class="text-2xl font-bold text-white mb-2 text-center cursor-pointer hover:underline">User</h2>
            <input id="login-username" type="text" placeholder="Username" class="hidden w-full max-w-xs px-4 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 mb-4 text-center">
            <div class="w-full max-w-xs space-y-4">
                <input id="login-password" type="password" placeholder="Password" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                <button id="sign-in-btn" class="w-full py-2 bg-purple-600 hover:bg-purple-700 rounded-md text-white font-semibold transition-colors">Sign In</button>
                <p class="text-center text-sm text-gray-400">No account? <button id="show-create-account-btn" class="text-purple-400 hover:underline">Create one</button></p>
            </div>
        </div>
        <div id="create-account-view" class="hidden relative z-10 flex flex-col items-center justify-center p-8 rounded-lg panel">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Create Account</h2>
            <div class="w-full max-w-xs space-y-4">
                <input id="create-username" type="text" placeholder="Username" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                <input id="create-password" type="password" placeholder="Password" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                <button id="create-account-btn" class="w-full py-2 bg-green-600 hover:bg-green-700 rounded-md text-white font-semibold transition-colors">Create Account</button>
                <p class="text-center text-sm text-gray-400">Already have an account? <button id="show-login-btn" class="text-purple-400 hover:underline">Sign In</button></p>
            </div>
        </div>
    </div>
    
    <!-- Disclaimer Modal -->
    <div id="disclaimer-modal" class="hidden absolute inset-0 z-[60] flex items-center justify-center bg-black/50">
        <div class="panel p-6 rounded-lg shadow-lg max-w-sm text-center animate-open">
            <h3 class="font-bold text-lg text-white mb-2">Disclaimer</h3>
            <p class="text-sm text-gray-300 mb-4">The background image is a placeholder. All other elements, logic, and designs are generated by an AI. This is a conceptual demonstration and not a final product.</p>
            <button id="disclaimer-ok-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-md text-white font-semibold">Got it</button>
        </div>
    </div>

    <!-- Custom Alert Modal Structure -->
    <div id="custom-alert-modal" class="custom-modal hidden">
        <div class="custom-modal-content">
            <p id="custom-alert-message"></p>
            <button id="custom-alert-ok-btn">OK</button>
        </div>
    </div>

    <!-- Custom Prompt Modal Structure -->
    <div id="custom-prompt-modal" class="custom-modal hidden">
        <div class="custom-modal-content">
            <h3 id="custom-prompt-title" class="font-bold text-lg text-white mb-2"></h3>
            <p id="custom-prompt-message" class="text-sm text-gray-300 mb-4"></p>
            <input type="text" id="custom-prompt-input" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 mt-2 mb-4">
            <div class="flex justify-end space-x-2">
                <button id="custom-prompt-cancel-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-md text-white font-semibold">Cancel</button>
                <button id="custom-prompt-ok-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-md text-white font-semibold">OK</button>
            </div>
        </div>
    </div>

    <!-- Desktop Container -->
    <div id="desktop-container" class="h-screen w-screen relative flex flex-col hidden">
        
        <!-- Top Bar -->
        <header class="h-20 w-full p-4 flex items-center space-x-4 panel">
            <span class="text-xl font-bold text-white">Apps</span>
            <button class="top-app-icon h-12 w-12 flex items-center justify-center bg-gray-700/50 hover:bg-gray-600/50 rounded-full transition-colors" data-window="file-explorer-window" title="File Explorer"><span class="material-symbols-outlined text-yellow-400">folder</span></button>
            <button class="top-app-icon h-12 w-12 flex items-center justify-center bg-gray-700/50 hover:bg-gray-600/50 rounded-full transition-colors" data-window="terminal-window" title="Terminal"><span class="material-symbols-outlined">terminal</span></button>
            <button class="top-app-icon h-12 w-12 flex items-center justify-center bg-gray-700/50 hover:bg-gray-600/50 rounded-full transition-colors" data-window="code-editor-window" title="Code Editor"><span class="material-symbols-outlined text-blue-400">data_object</span></button>
            <button class="top-app-icon h-12 w-12 flex items-center justify-center bg-gray-700/50 hover:bg-gray-600/50 rounded-full transition-colors" data-window="calculator-window" title="Calculator"><span class="material-symbols-outlined text-orange-400">calculate</span></button>
            <button class="top-app-icon h-12 w-12 flex items-center justify-center bg-gray-700/50 hover:bg-gray-600/50 rounded-full transition-colors" data-window="weather-window" title="Weather"><span class="material-symbols-outlined text-cyan-400">cloudy</span></button>
            <button class="top-app-icon h-12 w-12 flex items-center justify-center bg-gray-700/50 hover:bg-gray-600/50 rounded-full transition-colors" data-window="music-window" title="Music"><span class="material-symbols-outlined text-pink-400">music_note</span></button>
            <button class="top-app-icon h-12 w-12 flex items-center justify-center bg-gray-700/50 hover:bg-gray-600/50 rounded-full transition-colors" data-window="settings-window" title="Settings"><span class="material-symbols-outlined">settings</span></button>
            <button class="top-app-icon h-12 w-12 flex items-center justify-center bg-gray-700/50 hover:bg-gray-600/50 rounded-full transition-colors" data-window="support-window" title="Support Lifecycle"><span class="material-symbols-outlined text-red-400">support_agent</span></button>
            <!-- Dark/Light Mode Toggle Button -->
            <button id="theme-toggle-btn" class="top-app-icon h-12 w-12 flex items-center justify-center bg-gray-700/50 hover:bg-gray-600/50 rounded-full transition-colors" title="Toggle Theme">
                <span class="material-symbols-outlined" id="theme-toggle-icon">light_mode</span>
            </button>
        </header>

        <!-- Main Content Grid -->
        <main class="flex-grow p-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 panel rounded-lg p-6">
                 <h2 class="text-3xl font-bold text-white mb-4">Version 2.2.5</h2>
                 <p class="text-gray-300 mb-4">The installation process has been removed. The system now directly presents the login screen on startup, allowing for quicker access to your Windows 13 experience.</p>
                 <div class="flex items-center space-x-4 mb-4">
                    <h3 class="text-xl font-semibold text-gray-400">Current Time:</h3>
                    <p id="main-content-time" class="text-3xl text-white font-mono"></p>
                </div>
            </div>
            <div class="lg:col-span-1 flex flex-col space-y-8">
                <!-- Windows 14 Teaser Block -->
                <div class="panel rounded-lg p-6 text-center">
                    <h3 class="text-xl font-bold text-white mb-4">A Glimpse into the Future: Windows 14 Concept</h3>
                    <!-- Updated image source -->
                    <img src="Assets/Windows14/Windows14.png" alt="Windows 14 Concept Teaser" class="w-full h-auto rounded-lg mb-4 object-cover">
                    <p class="text-sm text-gray-300">This is an early idea for the next generation of Windows, focusing on a more fluid and integrated user experience. More details to come!</p>
                </div>
                <div class="panel rounded-lg p-4 text-center">
                    <h3 class="text-lg font-semibold text-gray-400 mb-2">Date</h3>
                    <p id="sidebar-date" class="text-2xl text-white"></p>
                </div>
                 <div class="panel rounded-lg p-4 text-center">
                    <h3 class="text-lg font-semibold text-gray-400 mb-2">Version</h3>
                    <p class="text-2xl text-white">2.2.5</p>
                </div>
            </div>
        </main>
        
        <!-- Windows Container (overlays everything) -->
        <div id="windows-container" class="absolute inset-0 w-full h-full pointer-events-none">
             <div id="settings-window" class="window hidden absolute top-1/4 left-1/4 w-full max-w-2xl panel rounded-lg shadow-2xl flex flex-col animate-open pointer-events-auto overflow-hidden"><div class="title-bar flex items-center justify-between p-2 border-b border-white/10"><div class="flex items-center space-x-2"><span class="material-symbols-outlined">settings</span><span>Settings</span></div><button class="close-btn p-1 rounded-full hover:bg-red-500 hover:text-white transition-colors" data-window="settings-window"><span class="material-symbols-outlined">close</span></button></div><div class="flex flex-grow bg-gray-800/50"><div class="w-1/3 p-4 border-r border-white/10 no-scrollbar overflow-y-auto"><h4 class="font-semibold mb-2">System</h4><a href="#about" class="settings-tab block p-2 rounded-lg hover:bg-white/20">About</a><h4 class="font-semibold mb-2 mt-4">Account</h4><a href="#account" class="settings-tab block p-2 rounded-lg hover:bg-white/20">Your Info</a></div><div class="w-2/3 p-4 no-scrollbar overflow-y-auto"><div id="about-content" class="settings-content hidden"><h4 class="font-semibold mb-2">About this PC</h4><div class="space-y-2 text-sm"><div><strong>Device Name:</strong> Win13-Concept</div><div><strong>OS Build:</strong> 2.2.5</div></div></div><div id="account-content" class="settings-content"><h4 class="font-semibold mb-2">Account</h4><div class="flex items-center space-x-4"><img src="https://placehold.co/64x64/7c3aed/ffffff?text=U" class="rounded-full w-16 h-16"><div id="account-username" class="font-semibold">User</div></div></div></div></div><div class="resize-handle"></div></div>
            <div id="file-explorer-window" class="window hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl h-96 panel rounded-lg shadow-2xl flex flex-col animate-open pointer-events-auto overflow-hidden"><div class="title-bar flex items-center justify-between p-2 border-b border-white/10"><div class="flex items-center space-x-2"><span class="material-symbols-outlined text-yellow-500">folder</span><span id="file-explorer-path">File Explorer</span></div><div class="flex items-center"><button id="new-file-btn" class="p-1 rounded-full hover:bg-white/20" title="New File"><span class="material-symbols-outlined">note_add</span></button><button class="close-btn p-1 rounded-full hover:bg-red-500 hover:text-white transition-colors" data-window="file-explorer-window"><span class="material-symbols-outlined">close</span></button></div></div><div id="file-explorer-output" class="p-4 flex-grow overflow-y-auto no-scrollbar grid grid-cols-4 gap-4 content-start bg-gray-800/50"></div><div class="resize-handle"></div></div>
            <div id="terminal-window" class="window hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl h-96 panel rounded-lg shadow-2xl flex flex-col animate-open pointer-events-auto overflow-hidden"><div class="title-bar flex items-center justify-between p-2 border-b border-white/10"><div class="flex items-center space-x-2"><span class="material-symbols-outlined">terminal</span><span>Terminal</span></div><button class="close-btn p-1 rounded-full hover:bg-red-500 hover:text-white transition-colors" data-window="terminal-window"><span class="material-symbols-outlined">close</span></button></div><div id="terminal-output" class="p-4 flex-grow bg-black/80 font-mono text-white text-sm overflow-y-auto no-scrollbar" onclick="document.getElementById('terminal-input')?.focus()"></div><div class="resize-handle"></div></div>
            <div id="code-editor-window" class="window hidden absolute top-1/4 left-1/4 w-3/4 h-3/4 panel rounded-lg shadow-2xl flex flex-col animate-open pointer-events-auto overflow-hidden">
                <div class="title-bar flex items-center justify-between p-2 border-b border-white/10">
                    <div class="flex items-center space-x-2">
                        <span class="material-symbols-outlined text-blue-400">data_object</span>
                        <span id="code-editor-title">Code Editor</span>
                    </div>
                    <div>
                        <button id="run-code-btn" class="p-1 rounded-full hover:bg-white/20" title="Run Code"><span class="material-symbols-outlined">play_arrow</span></button>
                        <button id="save-file-btn" class="p-1 rounded-full hover:bg-white/20" title="Save File"><span class="material-symbols-outlined">save</span></button>
                        <button class="close-btn p-1 rounded-full hover:bg-red-500 hover:text-white transition-colors" data-window="code-editor-window"><span class="material-symbols-outlined">close</span></button>
                    </div>
                </div>
                <div class="code-editor-container">
                    <div id="code-editor-sidebar" class="no-scrollbar">
                        <h4 class="text-xs font-semibold mb-2 text-gray-400">EXPLORER</h4>
                        <div id="editor-file-list">
                            <!-- Files will be rendered here -->
                        </div>
                    </div>
                    <div class="code-editor-main-panel">
                        <div id="code-editor-tab-bar" class="no-scrollbar">
                            <!-- Tabs will be rendered here -->
                        </div>
                        <div class="code-editor-content">
                            <div class="line-numbers no-scrollbar" id="line-numbers"></div>
                            <!-- Wrapper for textarea and highlighting -->
                            <div class="code-area-wrapper">
                                <pre><code id="code-highlighting"></code></pre>
                                <textarea id="code-editor-textarea" class="no-scrollbar" spellcheck="false" wrap="off"></textarea>
                            </div>
                        </div>
                        <div id="code-editor-bottom-panel" class="no-scrollbar">
                            Output:
                        </div>
                    </div>
                </div>
                <div class="resize-handle"></div>
            </div>
            <div id="calculator-window" class="window hidden absolute top-1/4 left-1/4 w-80 h-auto panel rounded-lg shadow-2xl flex flex-col animate-open pointer-events-auto overflow-hidden"><div class="title-bar flex items-center justify-between p-2 border-b border-white/10"><div class="flex items-center space-x-2"><span class="material-symbols-outlined text-orange-400">calculate</span><span>Calculator</span></div><button class="close-btn p-1 rounded-full hover:bg-red-500 hover:text-white transition-colors" data-window="calculator-window"><span class="material-symbols-outlined">close</span></button></div><div class="p-4 bg-gray-800/50 flex flex-col space-y-4"><div id="calc-display" class="w-full bg-black/50 rounded-lg p-4 text-right text-4xl font-mono truncate">0</div><div class="grid grid-cols-4 gap-2"><button class="calculator-btn" data-key="clear">C</button><button class="calculator-btn" data-key="%">%</button><button class="calculator-btn" data-key="backspace">⌫</button><button class="calculator-btn operator" data-key="/">÷</button><button class="calculator-btn" data-key="7">7</button><button class="calculator-btn" data-key="8">8</button><button class="calculator-btn" data-key="9">9</button><button class="calculator-btn operator" data-key="*">×</button><button class="calculator-btn" data-key="4">4</button><button class="calculator-btn" data-key="5">5</button><button class="calculator-btn" data-key="6">6</button><button class="calculator-btn operator" data-key="-">−</button><button class="calculator-btn" data-key="1">1</button><button class="calculator-btn" data-key="2">2</button><button class="calculator-btn" data-key="3">3</button><button class="calculator-btn operator" data-key="+">+</button><button class="calculator-btn col-span-2" data-key="0">0</button><button class="calculator-btn" data-key=".">.</button><button class="calculator-btn operator" data-key="=">=</button></div></div></div>
            <div id="weather-window" class="window hidden absolute top-1/4 left-1/4 w-96 h-auto panel rounded-lg shadow-2xl flex flex-col animate-open pointer-events-auto overflow-hidden"><div class="title-bar flex items-center justify-between p-2 border-b border-white/10"><div class="flex items-center space-x-2"><span class="material-symbols-outlined text-cyan-400">cloudy</span><span>Weather</span></div><button class="close-btn p-1 rounded-full hover:bg-red-500 hover:text-white transition-colors" data-window="weather-window"><span class="material-symbols-outlined">close</span></button></div><div id="weather-content" class="p-6 bg-gray-800/50 text-center flex flex-col items-center justify-center h-48"><p>Loading weather...</p></div></div>
            <div id="music-window" class="window hidden absolute top-1/4 left-1/4 w-96 h-auto panel rounded-lg shadow-2xl flex flex-col animate-open pointer-events-auto overflow-hidden"><div class="title-bar flex items-center justify-between p-2 border-b border-white/10"><div class="flex items-center space-x-2"><span class="material-symbols-outlined text-pink-400">music_note</span><span>Music</span></div><button class="close-btn p-1 rounded-full hover:bg-red-500 hover:text-white transition-colors" data-window="music-window"><span class="material-symbols-outlined">close</span></button></div><div class="p-6 bg-gray-800/50 flex flex-col items-center"><p class="font-semibold">Cyberpunk Dreams</p><p class="text-sm text-gray-400">Synthwave AI</p><div class="w-full h-2 bg-gray-600 rounded-full my-4"><div class="h-2 bg-pink-400 rounded-full w-1/2"></div></div><div class="flex items-center space-x-6 text-4xl"><span class="material-symbols-outlined">skip_previous</span><span class="material-symbols-outlined text-5xl">pause_circle</span><span class="material-symbols-outlined">skip_next</span></div></div></div>
            <div id="support-window" class="window hidden absolute top-1/4 left-1/4 w-full max-w-md h-auto panel rounded-lg shadow-2xl flex flex-col animate-open pointer-events-auto overflow-hidden"><div class="title-bar flex items-center justify-between p-2 border-b border-white/10"><div class="flex items-center space-x-2"><span class="material-symbols-outlined text-red-400">support_agent</span><span>Support Lifecycle</span></div><button class="close-btn p-1 rounded-full hover:bg-red-500 hover:text-white transition-colors" data-window="support-window"><span class="material-symbols-outlined">close</span></button></div><div class="p-6 bg-gray-800/50 text-center"><h4 class="text-lg font-bold">End of Support for Windows 13</h4><p class="text-sm text-gray-400">October 26, 2027</p><div id="support-countdown" class="mt-4 text-2xl font-mono"></div></div></div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- VFS & State ---
        let vfs = { 
            'C:': { 
                Users: { 
                    You: { 
                        Desktop: { 'welcome.txt': 'Welcome to Windows 13!' }, 
                        Documents: { 
                            'numpy_example.py': 'import numpy as np\n\narr = np.array([1, 2, 3])\nresult = arr + 5\nprint(f"Array: {arr}")\nprint(f"Result: {result}")\n\nscalar_multiply = np.array([10, 20]) * 2\nprint(f"Scalar multiply: {scalar_multiply}")\n\nmatrix_a = np.array([[1,2],[3,4]])\nmatrix_b = np.array([[5,6],[7,8]])\nmatrix_sum = matrix_a + matrix_b\nprint(f"Matrix sum: {matrix_sum}")',
                            'hello.py': 'print("Hello from Python in Windows 13!")\nx = 10\ny = 20\nprint(f"X + Y = {x+y}")'
                        } 
                    } 
                } 
            } 
        };
        let currentPath = "C:/Users/You/Desktop";
        // --- Simulated Python Environment ---
        const installedPythonPackages = new Set(['numpy']); // NumPy is "pre-installed" for demonstration
        
        // --- Simulated NumPy Library ---
        const np = {
            array: (data) => {
                // Simplistic array creation for 1D and 2D arrays
                if (Array.isArray(data) && data.every(Array.isArray)) {
                    // 2D Array (Matrix)
                    return {
                        _data: data,
                        toString: function() { return `np.array(${JSON.stringify(this._data)})`; },
                        valueOf: function() { return this._data; },
                        // Basic matrix addition
                        plus: function(other) {
                            if (!Array.isArray(other) || !other.every(Array.isArray) || this._data.length !== other.length || (this._data[0] && this._data[0].length !== other[0].length)) {
                                throw new Error("Operands must be matrices of the same shape for addition.");
                            }
                            return np.array(this._data.map((row, rIdx) => 
                                row.map((val, cIdx) => val + other[rIdx][cIdx])
                            ));
                        }
                    };
                } else if (Array.isArray(data)) {
                    // 1D Array
                    return {
                        _data: data,
                        toString: function() { return `np.array(${JSON.stringify(this._data)})`; },
                        valueOf: function() { return this._data; },
                        // Basic scalar addition/subtraction/multiplication/division
                        plus: function(scalar) { return np.array(this._data.map(val => val + scalar)); },
                        minus: function(scalar) { return np.array(this._data.map(val => val - scalar)); },
                        times: function(scalar) { return np.array(this._data.map(val => val * scalar)); },
                        divide: function(scalar) { return np.array(this._data.map(val => val / scalar)); }
                    };
                }
                return data; // Return as is if not an array
            }
        };

        // --- DOM Elements ---
        // Removed bootScreen, installScreen, installProgressBar, installStatusText
        const loginContainer = document.getElementById('login-container');
        const desktopContainer = document.getElementById('desktop-container');
        const disclaimerModal = document.getElementById('disclaimer-modal');
        const fileExplorerOutput = document.getElementById('file-explorer-output');
        const fileExplorerPathEl = document.getElementById('file-explorer-path');
        const terminalOutput = document.getElementById('terminal-output');
        const sidebarDate = document.getElementById('sidebar-date');
        const mainContentTime = document.getElementById('main-content-time');
        
        const codeEditorWindow = document.getElementById('code-editor-window');
        const codeEditorTitle = document.getElementById('code-editor-title');
        const codeEditorSidebar = document.getElementById('code-editor-sidebar');
        const editorFileList = document.getElementById('editor-file-list');
        const codeEditorTabBar = document.getElementById('code-editor-tab-bar');
        const codeEditorTextarea = document.getElementById('code-editor-textarea');
        const lineNumbersElement = document.getElementById('line-numbers');
        const codeHighlighting = document.getElementById('code-highlighting'); // New element reference
        const codeEditorBottomPanel = document.getElementById('code-editor-bottom-panel');
        const runCodeBtn = document.getElementById('run-code-btn');


        const supportCountdownEl = document.getElementById('support-countdown');
        const currentUsernameDisplay = document.getElementById('current-username-display');
        const loginUsernameInput = document.getElementById('login-username');
        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const themeToggleIcon = document.getElementById('theme-toggle-icon');
        const body = document.body;
        
        // --- Code Editor: Tab Management ---
        let openEditorTabs = []; // { id: string, filePath: string, title: string, content: string }
        let activeEditorTabId = null;

        const updateEditorUI = () => {
            // Update tabs
            codeEditorTabBar.innerHTML = '';
            openEditorTabs.forEach(tab => {
                const tabEl = document.createElement('div');
                tabEl.className = `editor-tab ${tab.id === activeEditorTabId ? 'active' : ''}`;
                tabEl.dataset.tabId = tab.id;
                tabEl.innerHTML = `<span>${tab.title}</span><span class="material-symbols-outlined tab-close-btn text-xs">close</span>`;
                tabEl.addEventListener('click', () => switchEditorTab(tab.id));
                tabEl.querySelector('.tab-close-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent switching tab when closing
                    closeEditorTab(tab.id);
                });
                codeEditorTabBar.appendChild(tabEl);
            });

            // Update textarea content, highlighting and line numbers
            const activeTab = openEditorTabs.find(tab => tab.id === activeEditorTabId);
            if (activeTab) {
                codeEditorTextarea.value = activeTab.content;
                codeHighlighting.innerHTML = highlightCode(activeTab.content); // Apply highlighting
                codeEditorTitle.textContent = activeTab.title;
                codeEditorTextarea.dataset.filePath = activeTab.filePath;
                updateLineNumbers();
            } else {
                codeEditorTextarea.value = '';
                codeHighlighting.innerHTML = ''; // Clear highlighting
                codeEditorTitle.textContent = 'Code Editor';
                codeEditorTextarea.dataset.filePath = '';
                lineNumbersElement.innerHTML = ''; // Clear line numbers
                codeEditorBottomPanel.textContent = 'Output:'; // Clear output panel
            }
        };

        const openEditorTab = (filePath) => {
            const fileName = filePath.split('/').pop();
            let existingTab = openEditorTabs.find(tab => tab.filePath === filePath);

            if (existingTab) {
                activeEditorTabId = existingTab.id;
            } else {
                const fileContent = getObjectFromPath(filePath);
                if (fileContent !== null && typeof fileContent === 'string') { // Ensure it's a file, not a directory
                    const newTab = {
                        id: `tab-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`, // Unique ID
                        filePath: filePath,
                        title: fileName,
                        content: fileContent
                    };
                    openEditorTabs.push(newTab);
                    activeEditorTabId = newTab.id;
                } else {
                    showAlert(`Cannot open '${fileName}'. It might be a directory or does not exist.`);
                    return;
                }
            }
            updateEditorUI();
        };

        const closeEditorTab = (tabIdToClose) => {
            const index = openEditorTabs.findIndex(tab => tab.id === tabIdToClose);
            if (index !== -1) {
                openEditorTabs.splice(index, 1);
                if (activeEditorTabId === tabIdToClose) {
                    // If the closed tab was active, switch to the next available tab
                    activeEditorTabId = openEditorTabs.length > 0 ? openEditorTabs[0].id : null;
                }
                updateEditorUI();
                // If no tabs are open, hide the editor window
                if (openEditorTabs.length === 0) {
                    codeEditorWindow.classList.add('hidden');
                }
            }
        };

        const switchEditorTab = (tabIdToActivate) => {
            activeEditorTabId = tabIdToActivate;
            updateEditorUI();
        };

        codeEditorTextarea.addEventListener('input', () => {
            // Update content of the active tab
            const activeTab = openEditorTabs.find(tab => tab.id === activeEditorTabId);
            if (activeTab) {
                activeTab.content = codeEditorTextarea.value;
                codeHighlighting.innerHTML = highlightCode(activeTab.content); // Update highlighting
            }
            updateLineNumbers();
        });


        // Custom Alert function
        const showAlert = (message) => {
            customAlertMessage.textContent = message;
            customAlertModal.classList.remove('hidden');
        };

        customAlertOkBtn.addEventListener('click', () => {
            customAlertModal.classList.add('hidden');
        });

        // Custom Prompt function
        const showCustomPrompt = (title, message, defaultValue = '', callback) => {
            document.getElementById('custom-prompt-title').textContent = title;
            document.getElementById('custom-prompt-message').textContent = message;
            document.getElementById('custom-prompt-input').value = defaultValue;
            document.getElementById('custom-prompt-modal').classList.remove('hidden');

            const okBtn = document.getElementById('custom-prompt-ok-btn');
            const cancelBtn = document.getElementById('custom-prompt-cancel-btn');
            const input = document.getElementById('custom-prompt-input');

            const handleOk = () => {
                const value = input.value;
                document.getElementById('custom-prompt-modal').classList.add('hidden');
                callback(value);
                removeListeners();
            };

            const handleCancel = () => {
                document.getElementById('custom-prompt-modal').classList.add('hidden');
                callback(null);
                removeListeners();
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    handleOk();
                } else if (e.key === 'Escape') {
                    handleCancel();
                }
            };

            okBtn.addEventListener('click', handleOk);
            cancelBtn.addEventListener('click', handleCancel);
            input.addEventListener('keydown', handleKeyDown);

            const removeListeners = () => {
                okBtn.removeEventListener('click', handleOk);
                cancelBtn.removeEventListener('click', handleCancel);
                input.removeEventListener('keydown', handleKeyDown);
            };

            input.focus();
        };

        // --- Theme Management ---
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                body.classList.remove('light');
                body.classList.add('dark');
                desktopContainer.style.backgroundImage = "url('Assets/Background/dark.png')";
                document.getElementById('login-background-blur').style.backgroundImage = "url('Assets/Background/dark.png')";
                themeToggleIcon.textContent = 'light_mode'; // Icon for dark mode
                localStorage.setItem('win13_theme', 'dark');
            } else {
                body.classList.remove('dark');
                body.classList.add('light');
                desktopContainer.style.backgroundImage = "url('Assets/Background/light.png')";
                document.getElementById('login-background-blur').style.backgroundImage = "url('Assets/Background/light.png')";
                themeToggleIcon.textContent = 'dark_mode'; // Icon for light mode
                localStorage.setItem('win13_theme', 'light');
            }
        };

        // Load theme from localStorage or default to dark
        const savedTheme = localStorage.getItem('win13_theme') || 'dark';
        applyTheme(savedTheme);

        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = body.classList.contains('dark') ? 'dark' : 'light';
            applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
        });
        
        // --- Account & Login ---
        let currentLoggedInUser = ''; // To store the logged-in username

        // Initialize username display based on last logged-in user or default
        const lastUser = localStorage.getItem('win13_last_user');
        if (lastUser) {
            currentUsernameDisplay.textContent = lastUser;
            loginUsernameInput.value = lastUser;
        }

        // Toggle username display and input
        currentUsernameDisplay.addEventListener('click', () => {
            currentUsernameDisplay.classList.add('hidden');
            loginUsernameInput.classList.remove('hidden');
            loginUsernameInput.focus();
        });

        loginUsernameInput.addEventListener('blur', () => {
            if (loginUsernameInput.value === '') {
                // If input is empty, revert to default display
                currentUsernameDisplay.textContent = 'User';
                loginUsernameInput.value = ''; // Clear input value
            } else {
                currentUsernameDisplay.textContent = loginUsernameInput.value;
            }
            currentUsernameDisplay.classList.remove('hidden');
            loginUsernameInput.classList.add('hidden');
        });

        document.getElementById('show-create-account-btn').addEventListener('click', () => { 
            document.getElementById('login-view').classList.add('hidden'); 
            document.getElementById('create-account-view').classList.remove('hidden'); 
        });

        document.getElementById('show-login-btn').addEventListener('click', () => { 
            document.getElementById('create-account-view').classList.add('hidden'); 
            document.getElementById('login-view').classList.remove('hidden'); 
        });

        document.getElementById('create-account-btn').addEventListener('click', () => {
            const user = document.getElementById('create-username').value;
            const pass = document.getElementById('create-password').value;
            console.log("Attempting to create account:", user);
            if (user && pass) { 
                localStorage.setItem(`win13_account_${user}`, pass); 
                console.log(`Account '${user}' created with password: ${pass}`);
                showAlert('Account created successfully!'); 
                // Update the displayed username immediately after creating an account
                currentUsernameDisplay.textContent = user;
                loginUsernameInput.value = user;
                document.getElementById('show-login-btn').click(); 
            } else { 
                showAlert('Please enter a username and password.'); 
                console.log("Account creation failed: Missing username or password.");
            }
        });

        document.getElementById('sign-in-btn').addEventListener('click', () => {
            const user = loginUsernameInput.value;
            const pass = document.getElementById('login-password').value;
            console.log("Attempting to sign in with user:", user, "and password:", pass);
            const storedPass = localStorage.getItem(`win13_account_${user}`);
            console.log("Stored password for user:", user, "is:", storedPass);

            if (storedPass && pass === storedPass) {
                currentLoggedInUser = user; // Set the logged-in user
                localStorage.setItem('win13_last_user', user); // Store last logged-in user
                document.getElementById('account-username').textContent = user;
                document.getElementById('boot-sound').play().catch(e => {});
                
                loginContainer.style.opacity = '0';
                document.getElementById('login-background-blur').style.filter = 'blur(0px)'; // Remove blur on desktop

                setTimeout(() => {
                    loginContainer.classList.add('hidden');
                    desktopContainer.classList.remove('hidden'); // Show desktop
                    desktopContainer.style.opacity = '1';
                    fetchWeather();
                    if (!localStorage.getItem('win13_disclaimer_seen')) { disclaimerModal.classList.remove('hidden'); }
                }, 500);
            } else { 
                showAlert('Invalid credentials. Please check your username and password, or create an account.'); 
                console.log("Login failed: Invalid credentials.");
            }
        });

        document.getElementById('disclaimer-ok-btn').addEventListener('click', () => {
            disclaimerModal.classList.add('hidden');
            localStorage.setItem('win13_disclaimer_seen', 'true');
        });

        // --- Weather Logic ---
        const fetchWeather = async () => {
            const apiKey = ""; // Use a real API key for production
            const city = "Louisville";
            const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=imperial`;
            const weatherContentEl = document.getElementById('weather-content');
            
            // This is a fallback since we cannot use a real API key here.
            const displayMockWeather = () => {
                 const weather = { temp: 75, description: "Clear", icon: "sunny" };
                 weatherContentEl.innerHTML = `
                    <span class="material-symbols-outlined text-9xl text-yellow-300">${weather.icon}</span>
                    <p class="text-5xl font-bold">${Math.round(weather.temp)}°F</p>
                    <p class="text-lg">${weather.description}</p>`;
            }

            try {
                if(!apiKey) {
                    displayMockWeather();
                    return;
                }
                const response = await fetch(url);
                if (!response.ok) throw new Error('Weather data not available.');
                const data = await response.json();
                
                let icon = 'cloudy';
                if (data.weather[0].main.includes('Clear')) icon = 'sunny';
                if (data.weather[0].main.includes('Rain')) icon = 'rainy';
                if (data.weather[0].main.includes('Thunderstorm')) icon = 'thunderstorm';

                weatherContentEl.innerHTML = `
                    <span class="material-symbols-outlined text-9xl text-yellow-300">${icon}</span>
                    <p class="text-5xl font-bold">${Math.round(data.main.temp)}°F</p>
                    <p class="text-lg">${data.weather[0].description}</p>`;

            } catch (error) {
                console.error(error);
                weatherContentEl.innerHTML = `<p>Could not fetch weather data.</p>`;
                 displayMockWeather(); // Display mock data on error
            }
        };

        // --- Date, Clock & Countdown ---
        const updateClock = () => {
            const now = new Date();
            const hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            // Update time in main content grid
            if (mainContentTime) {
                mainContentTime.textContent = `${String(hours % 12 || 12)}:${minutes} ${ampm}`;
            }
            sidebarDate.textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        };
        const updateCountdown = () => {
            const endDate = new Date('October 26, 2027 00:00:00');
            const now = new Date();
            const diff = endDate - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            if(supportCountdownEl) {
                supportCountdownEl.textContent = `${days}d ${hours}h ${minutes}m`;
            }
        };
        setInterval(updateClock, 1000);
        setInterval(updateCountdown, 1000 * 60);
        updateClock();
        updateCountdown();

        // --- Calculator Logic ---
        const calcDisplay = document.getElementById('calc-display');
        let firstValue = '';
        let operator = '';
        let shouldResetDisplay = false;
        
        document.querySelectorAll('.calculator-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const key = e.target.dataset.key;
                const isOperator = e.target.classList.contains('operator');
                
                if(!isNaN(key) || key === '.') {
                    if (shouldResetDisplay) { calcDisplay.textContent = ''; shouldResetDisplay = false; }
                    calcDisplay.textContent = calcDisplay.textContent === '0' ? key : calcDisplay.textContent + key;
                } else if(isOperator && key !== '=') {
                    firstValue = calcDisplay.textContent;
                    operator = key;
                    shouldResetDisplay = true;
                } else if (key === '=') {
                    if(operator && firstValue) {
                        const result = eval(`${parseFloat(firstValue)} ${operator} ${parseFloat(calcDisplay.textContent)}`);
                        calcDisplay.textContent = result;
                        firstValue = ''; operator = ''; shouldResetDisplay = true;
                    }
                } else if (key === 'clear') {
                    calcDisplay.textContent = '0'; firstValue = ''; operator = '';
                } else if (key === 'backspace') {
                    calcDisplay.textContent = calcDisplay.textContent.slice(0, -1) || '0';
                }
            });
        });
        
        // --- File System & Explorer ---
        const getObjectFromPath = (path) => path.split('/').filter(p => p).reduce((o, k) => o && o[k] ? o[k] : null, vfs);
        const renderFileExplorer = () => {
            fileExplorerOutput.innerHTML = '';
            fileExplorerPathEl.textContent = currentPath;
            const currentDir = getObjectFromPath(currentPath);
            if (!currentDir) { console.error("Could not find path:", currentPath); return; }
            if (currentPath !== 'C:') {
                const upIcon = document.createElement('div');
                upIcon.className = 'flex flex-col items-center p-2 rounded-lg hover:bg-white/20 cursor-pointer';
                upIcon.innerHTML = `<span class="material-symbols-outlined text-5xl text-yellow-500">subdirectory_arrow_left</span><span class="text-xs text-center truncate w-full">..</span>`;
                upIcon.addEventListener('dblclick', () => {
                    let parts = currentPath.split('/').filter(p => p); parts.pop();
                    currentPath = parts.length > 0 ? parts.join('/') : 'C:';
                    renderFileExplorer();
                });
                fileExplorerOutput.appendChild(upIcon);
            }
            Object.keys(currentDir).forEach(key => {
                const isDir = typeof currentDir[key] === 'object' && currentDir[key] !== null;
                const icon = document.createElement('div');
                icon.className = 'flex flex-col items-center p-2 rounded-lg hover:bg-white/20 cursor-pointer';
                icon.innerHTML = `<span class="material-symbols-outlined text-5xl ${isDir ? 'text-yellow-500' : 'text-gray-300'}">${isDir ? 'folder' : 'draft'}</span><span class="text-xs text-center truncate w-full">${key}</span>`;
                icon.addEventListener('dblclick', () => handleFileExplorerClick(key, isDir));
                fileExplorerOutput.appendChild(icon);
            });
        };
        const handleFileExplorerClick = (name, isDir) => {
            if (isDir) {
                currentPath = `${currentPath}/${name}`.replace('//', '/'); renderFileExplorer();
                renderCodeEditorSidebar(); // Update code editor sidebar if a directory changes
            } else {
                const filePath = `${currentPath}/${name}`.replace('//', '/');
                openWindow('code-editor-window');
                openEditorTab(filePath); // Open in code editor tab
            }
        };
        document.getElementById('save-file-btn').addEventListener('click', () => {
            const activeTab = openEditorTabs.find(tab => tab.id === activeEditorTabId);
            if (!activeTab) {
                showAlert("No file open to save.");
                return;
            }
            const path = activeTab.filePath;
            const content = activeTab.content;

            if (!path) {
                showAlert("Cannot save file: path is missing.");
                return;
            }

            const parts = path.split('/'); 
            const fileName = parts.pop();
            const dirPath = parts.join('/');
            const dir = getObjectFromPath(dirPath);

            if(dir && typeof dir === 'object') { 
                dir[fileName] = content; 
                showAlert(`File "${fileName}" saved successfully!`);
                // Re-render file explorer to ensure latest content is reflected if needed
                renderFileExplorer();
                renderCodeEditorSidebar(); // Update sidebar too
            } else {
                showAlert(`Error: Could not save file "${fileName}". Directory not found.`);
            }
        });

        document.getElementById('new-file-btn').addEventListener('click', () => {
            showCustomPrompt("Create New File", "Enter the name for the new file:", "new_file.txt", (fileName) => {
                if (fileName) { // If user provided a filename (not cancelled)
                    const currentDir = getObjectFromPath(currentPath);
                    if (currentDir && typeof currentDir === 'object') {
                        if (!currentDir[fileName]) {
                            currentDir[fileName] = ''; // Create empty file
                            renderFileExplorer(); // Re-render to show new file
                            renderCodeEditorSidebar(); // Update sidebar too
                            showAlert(`File '${fileName}' created successfully!`);
                            // Optionally, open the new file in the editor
                            openWindow('code-editor-window');
                            openEditorTab(`${currentPath}/${fileName}`);
                        } else {
                            showAlert(`Error: File or directory named '${fileName}' already exists.`);
                        }
                    } else {
                        showAlert(`Error: Current path is not a valid directory.`);
                    }
                } else {
                    showAlert("File creation cancelled.");
                }
            });
        });

        // --- Code Editor Sidebar ---
        const renderCodeEditorSidebar = () => {
            editorFileList.innerHTML = ''; // Clear existing list
            const currentDir = getObjectFromPath(currentPath);
            if (!currentDir || typeof currentDir !== 'object') {
                editorFileList.innerHTML = '<div class="text-gray-500 text-sm">Cannot display files. Invalid path.</div>';
                return;
            }

            Object.keys(currentDir).forEach(key => {
                const isDir = typeof currentDir[key] === 'object' && currentDir[key] !== null;
                const fileItem = document.createElement('div');
                fileItem.className = 'editor-file-item';
                fileItem.innerHTML = `<span class="material-symbols-outlined text-sm mr-2">${isDir ? 'folder' : 'description'}</span><span>${key}</span>`;
                if (!isDir) { // Only allow opening files, not directories, in the editor
                    const filePath = `${currentPath}/${key}`.replace('//', '/');
                    fileItem.dataset.filePath = filePath;
                    fileItem.addEventListener('click', () => {
                        openEditorTab(filePath);
                        updateEditorUI();
                    });
                } else {
                    fileItem.classList.add('opacity-50', 'cursor-not-allowed'); // Indicate it's a directory and not directly editable
                }
                editorFileList.appendChild(fileItem);
            });
        };

        // --- Terminal ---
        const terminalClearLastLines = (numLines) => {
            const children = terminalOutput.children;
            for (let i = 0; i < numLines; i++) {
                if (children.length > 0) {
                    terminalOutput.removeChild(children[children.length - 1]);
                }
            }
        };

        const processCommand = (cmd) => {
            const [command, ...args] = cmd.trim().split(' '); if (!command) return;
            const append = (text) => appendTerminalOutput(text);

            if (command.toLowerCase() === 'pip' && args[0] === 'install') {
                const packageName = args[1];
                if (!packageName) {
                    append('Usage: pip install [package_name]');
                    createPrompt();
                    return;
                }
                if (installedPythonPackages.has(packageName)) {
                    append(`Package '${packageName}' is already installed.`);
                    createPrompt();
                    return;
                }

                // Simulate installation process
                append(`Downloading package ${packageName}...`);
                let progress = 0;
                let progressInterval;
                let statusLineIndex; // To update the progress line

                setTimeout(() => {
                    append(`Installing collected packages: ${packageName}`);
                    append(`<span id="pip-progress-line"></span>`); // Placeholder for the progress bar line
                    statusLineIndex = terminalOutput.children.length - 1; // Get index of this line

                    progressInterval = setInterval(() => {
                        progress += 10;
                        if (progress <= 100) {
                            const progressBar = '[' + '#'.repeat(progress / 10) + ' '.repeat(10 - (progress / 10)) + ']';
                            const statusText = `  ${progressBar} ${progress}%`;
                            
                            // Update the specific progress line
                            if (terminalOutput.children[statusLineIndex]) {
                                terminalOutput.children[statusLineIndex].innerHTML = statusText;
                            }
                            terminalOutput.scrollTop = terminalOutput.scrollHeight;
                        } else {
                            clearInterval(progressInterval);
                            installedPythonPackages.add(packageName);
                            terminalClearLastLines(1); // Clear the progress bar line
                            append(`Successfully installed ${packageName}`);
                            createPrompt();
                        }
                    }, 200); // Update every 200ms
                }, 1000); // Start installation after 1 second download

                return; // Prevent default prompt creation for pip install
            }

            // Normal command processing
            switch (command.toLowerCase()) {
                case 'ls':
                    const dirContent = getObjectFromPath(currentPath);
                    if (dirContent) append(Object.keys(dirContent).join('  ')); else append('Error: Invalid path');
                    break;
                case 'cd':
                    let newPath = args[0]; if (!newPath) { append('Usage: cd [path]'); break; }
                    if (newPath === '..') {
                        let parts = currentPath.split('/').filter(p => p);
                        if (parts.length > 1) { currentPath = parts.slice(0, -1).join('/'); } 
                        else { currentPath = 'C:'; }
                    } else {
                        const targetPath = `${currentPath}/${newPath}`.replace('//', '/');
                        if (getObjectFromPath(targetPath) && typeof getObjectFromPath(targetPath) === 'object') { 
                            currentPath = targetPath; 
                        } else { 
                            append(`Error: Directory not found: ${newPath}`); 
                        }
                    }
                    renderFileExplorer();
                    renderCodeEditorSidebar(); // Also update the code editor sidebar
                    break;
                case 'mkdir':
                    if (!args[0]) { append("Usage: mkdir [directory_name]"); break; }
                    const currentDir = getObjectFromPath(currentPath);
                    if (currentDir && typeof currentDir === 'object') { 
                        if (!currentDir[args[0]]) {
                            currentDir[args[0]] = {}; 
                            append(`Directory '${args[0]}' created.`); 
                            renderFileExplorer();
                            renderCodeEditorSidebar(); 
                        } else {
                            append(`Error: Directory '${args[0]}' already exists.`);
                        }
                    } else { append(`Error: Path not found.`); }
                    break;
                case 'rm': // Simulated remove command for files
                    if (!args[0]) { append("Usage: rm [file_name]"); break; }
                    const parentDirParts = currentPath.split('/').filter(p => p);
                    const parentDir = getObjectFromPath(parentDirParts.join('/'));
                    if (parentDir && parentDir[args[0]] !== undefined && typeof parentDir[args[0]] !== 'object') {
                        delete parentDir[args[0]];
                        append(`File '${args[0]}' removed.`);
                        renderFileExplorer();
                        renderCodeEditorSidebar();
                        // Also close any open tabs for this file
                        openEditorTabs = openEditorTabs.filter(tab => tab.filePath !== `${currentPath}/${args[0]}`.replace('//', '/'));
                        if (activeEditorTabId && !openEditorTabs.find(tab => tab.id === activeEditorTabId)) {
                             activeEditorTabId = openEditorTabs.length > 0 ? openEditorTabs[0].id : null;
                        }
                        updateEditorUI();
                    } else {
                        append(`Error: File '${args[0]}' not found or is a directory.`);
                    }
                    break;
                case 'help':
                    append("Available commands:");
                    append("  ls - List contents of current directory");
                    append("  cd [path] - Change directory (use '..' to go up)");
                    append("  mkdir [name] - Create a new directory");
                    append("  rm [file_name] - Remove a file");
                    append("  pip install [package] - Simulate installing a Python package with progress");
                    append("  pip list - List simulated installed Python packages");
                    append("  restart - Restart the OS simulation");
                    append("  Note: For basic NumPy simulation, run a .py file from the Code Editor.");
                    break;
                case 'pip': // For pip list and other pip commands
                    if (args[0] === 'list') {
                        if (installedPythonPackages.size > 0) {
                            append('Simulated Installed Python Packages:');
                            installedPythonPackages.forEach(pkg => append(`- ${pkg}`));
                        } else {
                            append('No Python packages installed yet.');
                        }
                    } else {
                        append('Usage: pip [install|list]');
                    }
                    break;
                case 'restart': append('Restarting...'); setTimeout(() => window.location.reload(), 1000); break;
                default: append(`'${command}' is not recognized. Type 'help' for available commands.`);
            }
            createPrompt(); // Always create prompt after normal command
        };

        const createPrompt = () => {
            const promptContainer = document.createElement('div');
            promptContainer.className = 'flex';
            promptContainer.innerHTML = `<span class="text-green-400">${currentPath}>&nbsp;</span><input type="text" id="terminal-input" class="flex-grow bg-transparent border-none outline-none font-mono text-white">`;
            terminalOutput.appendChild(promptContainer);
            const input = document.getElementById('terminal-input');
            input.focus();
            input.addEventListener('keydown', (e) => { if(e.key === 'Enter') handleTerminalInput(e); });
        };
        const handleTerminalInput = (e) => {
            const input = e.target; const cmd = input.value;
            input.parentElement.remove();
            appendTerminalOutput(`<span class="text-green-400">${currentPath}>&nbsp;</span>${cmd}`);
            processCommand(cmd);
        };
        const appendTerminalOutput = (text) => { terminalOutput.innerHTML += `<div>${text.replace(/\n/g, '<br>')}</div>`; terminalOutput.scrollTop = terminalOutput.scrollHeight; };

        // --- Code Editor: Line Numbers & Run Logic ---
        const updateLineNumbers = () => {
            const lines = codeEditorTextarea.value.split('\n');
            const lineCount = lines.length;
            let numbersHtml = '';
            for (let i = 1; i <= lineCount; i++) {
                numbersHtml += `<div>${i}</div>`;
            }
            lineNumbersElement.innerHTML = numbersHtml;
            // Ensure line numbers scroll with the textarea
            lineNumbersElement.scrollTop = codeEditorTextarea.scrollTop;
        };

        // Helper to escape HTML characters for display within a <pre> tag
        const escapeHtmlForDisplay = (str) => {
            return str.replace(/&/g, "&amp;")
                      .replace(/</g, "&lt;")
                      .replace(/>/g, "&gt;")
                      .replace(/"/g, "&quot;")
                      .replace(/'/g, "&#039;");
        };

        // Basic Syntax Highlighting Function (Python-focused)
        const highlightCode = (text) => {
            const keywords = '\\b(import|as|def|print|return|if|else|elif|for|while|in|True|False|None|and|or|not|class|try|except|finally|with|as|del|from|global|is|lambda|nonlocal|pass|raise|yield|print|input|len|range|list|dict|set|tuple|str|int|float|bool|append|insert|remove|pop|sort|reverse|keys|values|items)\\b';
            const strings = '(["\'])(?:(?=(\\\\?))\\2.)*?\\1'; // Handles " and ' strings, escaped internal quotes
            const comments = '#.*$'; // Matches until end of line
            const numbers = '\\b\\d+(\\.\\d+)?\\b';
            const functions = '\\b([a-zA-Z_]\\w*)\\s*\\('; // Captures function name only, looks ahead for '('
            const operators = '[+\\-*/%=!&|<>]=?|[+\\-*/%=!&|<>]{1}'; // Covers +, -, *, /, %, =, ==, !=, >=, <=, etc.

            // Combine all regexes with capture groups for each type.
            // Order matters: more specific (like strings, comments) before less specific (like keywords)
            // to prevent partial matches.
            const regex = new RegExp(
                `(${comments})|` +      // Group 1: Comments
                `(${strings})|` +       // Group 2: Strings
                `(${keywords})|` +      // Group 3: Keywords
                `(${numbers})|` +       // Group 4: Numbers
                `(${functions})|` +     // Group 5: Function Calls (whole match for func + '(')
                `(${operators})|` +     // Group 6: Operators
                `([^\\n]+)`             // Group 7: Catch-all for plain text per line
            , 'gm'); // g for global, m for multiline (for comments)

            // The main replace function for syntax highlighting
            return text.replace(regex, (match, comment, str, keyword, num, funcCall, operator, plainText) => {
                if (comment !== undefined) { // Check for undefined as empty match is possible
                    return `<span class="syntax-comment">${escapeHtmlForDisplay(comment)}</span>`;
                } else if (str !== undefined) {
                    return `<span class="syntax-string">${escapeHtmlForDisplay(str)}</span>`;
                } else if (keyword !== undefined) {
                    return `<span class="syntax-keyword">${escapeHtmlForDisplay(keyword)}</span>`;
                } else if (num !== undefined) {
                    return `<span class="syntax-number">${escapeHtmlForDisplay(num)}</span>`;
                } else if (funcCall !== undefined) {
                    // funcCall is like "func("
                    // We need to extract the name and apply the span, then add the '('.
                    const funcNameMatch = funcCall.match(/\b([a-zA-Z_]\w*)\s*\(/);
                    if (funcNameMatch && funcNameMatch[1]) {
                        const funcName = funcNameMatch[1]; // The function name itself
                        const parenPart = funcCall.substring(funcName.length); // The '(' part
                        return `<span class="syntax-function">${escapeHtmlForDisplay(funcName)}</span>${escapeHtmlForDisplay(parenPart)}`;
                    }
                    return escapeHtmlForDisplay(funcCall); // Fallback if regex for funcNameMatch fails
                } else if (operator !== undefined) {
                    return `<span class="syntax-operator">${escapeHtmlForDisplay(operator)}</span>`;
                } else if (plainText !== undefined) {
                    // This handles newlines correctly and ensures any un-matched text is escaped.
                    return escapeHtmlForDisplay(plainText);
                }
                return escapeHtmlForDisplay(match); // Fallback for unmatched characters, ensures they are escaped
            });
        };


        codeEditorTextarea.addEventListener('input', () => {
            // Update content of the active tab
            const activeTab = openEditorTabs.find(tab => tab.id === activeEditorTabId);
            if (activeTab) {
                activeTab.content = codeEditorTextarea.value;
                codeHighlighting.innerHTML = highlightCode(activeTab.content); // Update highlighting
            }
            updateLineNumbers();
        });

        codeEditorTextarea.addEventListener('scroll', () => {
            lineNumbersElement.scrollTop = codeEditorTextarea.scrollTop;
            codeHighlighting.scrollTop = codeEditorTextarea.scrollTop; // Synchronize highlighting scroll
        });

        // Initial update of line numbers and highlighting when the editor is opened
        const observer = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (!codeEditorWindow.classList.contains('hidden')) { // Use codeEditorWindow here
                        updateLineNumbers();
                        renderCodeEditorSidebar(); // Render sidebar when editor opens
                        // Ensure highlighting is applied when opening a file
                        const activeTab = openEditorTabs.find(tab => tab.id === activeEditorTabId);
                        if (activeTab) {
                            codeHighlighting.innerHTML = highlightCode(activeTab.content);
                        }
                    }
                }
            }
        });
        // Observe the code editor window for class changes (like hidden/shown)
        observer.observe(codeEditorWindow, { attributes: true });


        // Simulate running Python code
        runCodeBtn.addEventListener('click', () => {
            const activeTab = openEditorTabs.find(tab => tab.id === activeEditorTabId);
            if (!activeTab) {
                codeEditorBottomPanel.textContent = 'Output: No file selected to run.';
                return;
            }

            const code = activeTab.content;
            const filename = activeTab.title;

            codeEditorBottomPanel.textContent = `Output:\nRunning code from ${filename}:\n`;
            
            // Handle Python files with NumPy simulation
            if (filename.endsWith('.py')) {
                // Output buffer for simulated print statements
                let simulatedOutput = '';
                const mockPrint = (message) => {
                    simulatedOutput += String(message) + '\n';
                };

                try {
                    let transformedCode = code;

                    // 1. Handle 'import numpy as np' by just removing it (np is passed in scope)
                    transformedCode = transformedCode.replace(/import\s+numpy\s+as\s+np/g, '');

                    // 2. Transform print statements to mockPrint calls.
                    // This needs to evaluate the argument to print *within the target JS scope*.
                    transformedCode = transformedCode.replace(/print\s*\(([^)]*)\)/g, `mockPrint($1)`);

                    // 3. Transform basic array operations (e.g., arr + 5, arr * 2)
                    // Ensure these transformations are applied carefully to avoid issues with strings/comments.
                    // For a simple demo, we'll assume these operations are on variables.
                    transformedCode = transformedCode.replace(/(\w+)\s*\+\s*(\S+)/g, (match, varName, operand) => `${varName}.plus(${operand})`);
                    transformedCode = transformedCode.replace(/(\w+)\s*-\s*(\S+)/g, (match, varName, operand) => `${varName}.minus(${operand})`);
                    transformedCode = transformedCode.replace(/(\w+)\s*\*\s*(\S+)/g, (match, varName, operand) => `${varName}.times(${operand})`);
                    transformedCode = transformedCode.replace(/(\w+)\s*\/\s*(\S+)/g, (match, varName, operand) => `${varName}.divide(${operand})`);

                    // 4. Transform np.array() creation. This needs to use the provided __simulated_np_array.
                    // Crucially, the *content* of np.array() needs to be valid JSON in JS. Python uses single quotes.
                    transformedCode = transformedCode.replace(/np\.array\(([^)]*)\)/g, (match, arrayContent) => {
                        // Replace Python single quotes with double quotes for JSON parsing
                        const jsArrayContent = arrayContent.replace(/'/g, '"');
                        return `__simulated_np_array(${jsArrayContent})`;
                    });

                    // 5. Transform Python assignments to use `var` in the JS context.
                    // This is a *very* basic translation and assumes simple assignments.
                    // Complex expressions on the right-hand side will be evaluated by JS.
                    transformedCode = transformedCode.replace(/^(\s*)(\w+)\s*=\s*([^\n;]+?)\s*$/gm, (match, leadingSpaces, varName, expression) => {
                        return `${leadingSpaces}var ${varName} = ${expression};`;
                    });

                    // Construct the final code string to be executed by new Function
                    const finalCodeToExecute = `
                        ${transformedCode}
                    `;

                    // Execute the transformed code in an isolated scope
                    // Pass mockPrint and np (our simulated NumPy object) as arguments.
                    new Function('mockPrint', 'np', '__simulated_np_array', finalCodeToExecute)(mockPrint, np, np.array);
                    
                    if (simulatedOutput) {
                        codeEditorBottomPanel.textContent += `Python Output:\n${simulatedOutput.trim()}\n`;
                    } else {
                        codeEditorBottomPanel.textContent += 'Python script executed with no direct output.\n';
                    }

                } catch (e) {
                    codeEditorBottomPanel.textContent += `Python Runtime Error: ${e.message}\n`;
                }
            } else {
                // For non-Python files, just log a message
                codeEditorBottomPanel.textContent += `Cannot run non-Python files directly yet. (File: ${filename})\n`;
            }
            codeEditorBottomPanel.scrollTop = codeEditorBottomPanel.scrollHeight;
        });


        // --- Window Management ---
        let activeWindow = null, actionType = null, startX, startY, startW, startH, startLeft, startTop;
        const startAction = (e, windowEl, currentAction) => {
            actionType = currentAction; activeWindow = windowEl;
            document.querySelectorAll('.window').forEach(w => w.style.zIndex = '40');
            activeWindow.style.zIndex = '45';
            const event = e.type === 'touchstart' ? e.touches[0] : e;
            startX = event.clientX; startY = event.clientY;
            startW = parseInt(document.defaultView.getComputedStyle(activeWindow).width, 10);
            startH = parseInt(document.defaultView.getComputedStyle(activeWindow).height, 10);
            startLeft = activeWindow.offsetLeft; startTop = activeWindow.offsetTop;
            document.addEventListener('mousemove', doAction); document.addEventListener('mouseup', endAction);
            document.addEventListener('touchmove', doAction, { passive: false }); document.addEventListener('touchend', endAction);
        };
        const doAction = (e) => {
            if (!activeWindow) return; e.preventDefault();
            const event = e.type === 'touchmove' ? e.touches[0] : e;
            const dx = event.clientX - startX; const dy = event.clientY - startY;
            if (actionType === 'drag') {
                activeWindow.style.left = `${startLeft + dx}px`;
                activeWindow.style.top = `${startTop + dy}px`;
            } else if (actionType === 'resize') {
                activeWindow.style.width = `${startW + dx}px`;
                activeWindow.style.height = `${startH + dy}px`;
            }
        };
        const endAction = () => {
            activeWindow = null; actionType = null;
            document.removeEventListener('mousemove', doAction); document.removeEventListener('mouseup', endAction);
            document.removeEventListener('touchmove', doAction); document.removeEventListener('touchend', endAction);
        };
        document.querySelectorAll('.window').forEach(win => {
            const titleBar = win.querySelector('.title-bar');
            const resizeHandle = win.querySelector('.resize-handle');
            if (titleBar) { titleBar.addEventListener('mousedown', e => startAction(e, win, 'drag')); titleBar.addEventListener('touchstart', e => startAction(e, win, 'drag')); }
            if (resizeHandle) { resizeHandle.addEventListener('mousedown', e => startAction(e, win, 'resize')); resizeHandle.addEventListener('touchstart', e => startAction(e, win, 'resize')); }
        });
        
        // --- Init & Other Listeners ---
        const openWindow = (windowId) => {
            const windowEl = document.getElementById(windowId);
            if(windowEl) windowEl.classList.remove('hidden');
            if(windowId === 'terminal-window' && !terminalOutput.hasChildNodes()) createPrompt();
            if(windowId === 'file-explorer-window') renderFileExplorer();
            if(windowId === 'code-editor-window') {
                // Ensure line numbers are updated and sidebar rendered when code editor is opened
                updateLineNumbers();
                renderCodeEditorSidebar();
                // Re-apply highlighting when the window is opened
                const activeTab = openEditorTabs.find(tab => tab.id === activeEditorTabId);
                if (activeTab) {
                    codeHighlighting.innerHTML = highlightCode(activeTab.content);
                }
            }
        };
        document.querySelectorAll('[data-window]').forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); openWindow(btn.getAttribute('data-window')); }));
        document.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); document.getElementById(btn.getAttribute('data-window')).classList.add('hidden'); }));
        const settingsTabs = document.querySelectorAll('.settings-tab');
        const settingsContents = document.querySelectorAll('.settings-content');
        settingsTabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                settingsTabs.forEach(t => t.classList.remove('bg-white/20'));
                tab.classList.add('bg-white/20');
                settingsContents.forEach(content => content.classList.add('hidden'));
                const targetId = tab.getAttribute('href').substring(1) + '-content';
                document.getElementById(targetId).classList.remove('hidden');
            });
        });
        document.querySelector('.settings-tab[href="#about"]')?.click();


        // --- Install Process Logic - Removed ---
        // The previous `simulateInstallation` and `startInstallSteps` functions are now removed.
        // The logic for handling initial load now resides directly in the DOMContentLoaded listener.

        // Initial Load: Directly show login screen, then transition to desktop on login
        // Also removed the `isInstalled` localStorage check, as installation is no longer simulated.
        loginContainer.classList.remove('hidden'); // Show login screen initially
        loginContainer.style.opacity = '1'; // Ensure it's visible on load
        desktopContainer.classList.add('hidden'); // Desktop starts hidden
    });
    </script>
</body>
</html>

